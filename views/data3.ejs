<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Music Player</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet"/>
  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- Exact Reference Theming --- */
    :root {
      /* Light Mode Palette (Beige/Blue/White) */
      --bg-gradient: linear-gradient(180deg, #FDFBF7 0%, #F4F7F6 40%, #E6EEF5 100%);
      --text-main: #333333;
      --text-sub: #888888;
      
      --accent-blue: #5B8DEF; /* The blue used in tabs/controls */
      --accent-light: #DCE8F9;
      
      --card-bg: rgba(255, 255, 255, 0.7);
      --glass-border: 1px solid rgba(255, 255, 255, 0.5);
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.05);
      
      /* Specific Elements */
      --tab-bg: #FFFFFF;
      --tab-active-bg: #5B8DEF;
      --tab-active-text: #FFFFFF;
      
      --search-bg: #FFFFFF;
      
      --track-icon-bg: #FFFFFF;
      --track-icon-color: #5B8DEF;
      
      --player-bg: rgba(255, 255, 255, 0.85);
      --player-shadow: 0 -10px 40px rgba(91, 141, 239, 0.15);
    }

    body.dark-mode {
      /* Dark Mode Palette (Navy/Black/Blue) */
      --bg-gradient: linear-gradient(180deg, #1A1D24 0%, #131519 100%);
      --text-main: #FFFFFF;
      --text-sub: #8892B0;
      
      --accent-blue: #5B8DEF;
      --accent-light: rgba(91, 141, 239, 0.2);
      
      --card-bg: rgba(30, 32, 40, 0.6);
      --glass-border: 1px solid rgba(255, 255, 255, 0.05);
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.3);
      
      --tab-bg: #252830;
      --tab-active-bg: #2C303A; /* Slightly lighter in dark mode or keep blue */
      --tab-active-text: #FFFFFF;
      
      --search-bg: #252830;
      
      --track-icon-bg: #2C303A;
      --track-icon-color: #5B8DEF;
      
      --player-bg: rgba(20, 22, 28, 0.9);
      --player-shadow: 0 -10px 40px rgba(0,0,0,0.5);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-main);
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* --- Top Navigation Area --- */
    .top-nav {
      padding: 40px 20px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    /* Pill Tabs */
    .tabs-container {
      background: var(--tab-bg);
      border-radius: 30px;
      padding: 4px;
      display: flex;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }

    .tab-btn {
      padding: 8px 24px;
      border-radius: 25px;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      background: transparent;
      color: var(--text-sub);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      background: var(--tab-active-bg);
      color: var(--tab-active-text);
      box-shadow: 0 4px 12px rgba(91, 141, 239, 0.3);
    }

    /* Top Right Icons */
    .top-icons {
      display: flex;
      gap: 12px;
    }

    .icon-circle {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: var(--tab-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-blue);
      font-size: 1.2rem;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      transition: transform 0.2s;
    }
    .icon-circle:active { transform: scale(0.95); }

    /* --- Search Section --- */
    .search-section {
      padding: 5px 20px 15px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 9;
    }

    .search-bar-wrapper {
      position: relative;
      width: 100%;
    }

    .search-input {
      width: 100%;
      background: var(--search-bg);
      border: none;
      padding: 14px 20px;
      border-radius: 20px;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: var(--text-main);
      box-shadow: 0 2px 10px rgba(0,0,0,0.02);
    }
    
    /* Removed mic icon and filter row CSS as requested */

    /* --- Song List --- */
    .music-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 20px 320px; /* Space for large bottom player */
      scrollbar-width: none;
    }
    .music-list::-webkit-scrollbar { display: none; }

    .track-item {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      cursor: pointer;
    }

    /* Play Icon Circle */
    .track-icon {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      background: var(--track-icon-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--track-icon-color);
      font-size: 1.2rem;
      flex-shrink: 0;
      margin-right: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    }

    .track-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Visual Hierarchy: Reference Style */
    .track-artist-small {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-sub);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .track-name-large {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Kebab Menu (3 Dots) */
    .track-menu-btn {
      padding: 10px;
      background: transparent;
      border: none;
      color: var(--text-sub);
      font-size: 1.4rem;
      cursor: pointer;
    }

    /* Active State styling */
    .track-item.active .track-icon {
        background: var(--accent-blue);
        color: #fff;
        box-shadow: 0 4px 15px rgba(91, 141, 239, 0.4);
    }
    
    .track-item.active .track-name-large {
        color: var(--accent-blue);
    }

    /* --- Bottom Player (Floating Card) --- */
    .player-container {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      z-index: 100;
    }

    .player-card {
      background: var(--player-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 35px;
      padding: 25px 30px;
      box-shadow: var(--player-shadow);
      border: var(--glass-border);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .player-title-row {
      margin-bottom: 20px;
      width: 100%;
    }

    .p-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .p-artist {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-sub);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Progress Bar */
    .progress-area {
      width: 100%;
      margin-bottom: 25px;
      position: relative;
    }

    .progress-bg {
      width: 100%;
      height: 5px;
      background: rgba(91, 141, 239, 0.15); /* Light blue track */
      border-radius: 10px;
    }

    /* Input Range Styling */
    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 5px;
      background: transparent;
      position: absolute;
      top: 0; left: 0;
      margin: 0;
      cursor: pointer;
    }

    input[type=range]:focus { outline: none; }

    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 18px; 
        width: 18px; 
        border-radius: 50%;
        background: #FFFFFF; /* White knob */
        border: 1px solid rgba(0,0,0,0.1);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        margin-top: -6px; /* Center on track */
    }
    
    /* Fill part logic handled in JS via gradient on input */

    .time-row {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-sub);
    }

    /* Controls */
    .controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0 10px;
    }

    .ctrl-btn-small {
      background: transparent;
      border: none;
      color: var(--accent-blue);
      font-size: 1.4rem;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .ctrl-btn-small:hover { opacity: 1; }
    .ctrl-btn-small.active { opacity: 1; text-shadow: 0 0 10px var(--accent-blue); }

    .ctrl-btn-med {
        background: transparent;
        border: none;
        color: var(--accent-blue);
        font-size: 1.8rem;
        cursor: pointer;
    }

    .play-btn-large {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: #FFFFFF;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-blue);
      font-size: 2.2rem; /* Big icon */
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .play-btn-large:active { transform: scale(0.95); }
    
    /* Dark mode play button tweaks */
    body.dark-mode .play-btn-large {
        background: #2C303A;
        color: #5B8DEF;
        box-shadow: 0 5px 20px rgba(0,0,0,0.4);
    }

    /* --- Modals & Sheets --- */
    .overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 200; display: none;
        align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    
    .modal-box {
        background: var(--tab-bg);
        padding: 30px; border-radius: 25px; width: 85%; max-width: 320px;
        text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }
    .modal-box input {
        width: 100%; padding: 12px; margin: 15px 0; border-radius: 12px;
        border: 1px solid rgba(0,0,0,0.1); background: rgba(0,0,0,0.05);
        color: var(--text-main);
    }
    .modal-actions { display: flex; gap: 15px; justify-content: center; }
    
    /* Bottom Sheet */
    .bottom-sheet {
        position: fixed; bottom: -100%; left: 0; width: 100%;
        background: var(--tab-bg);
        border-radius: 30px 30px 0 0; padding: 25px 25px 40px;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
        transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 201; display: flex; flex-direction: column; gap: 8px;
    }
    .menu-item {
        padding: 15px; display: flex; gap: 15px; align-items: center;
        font-size: 1rem; color: var(--text-main); background: transparent;
        border: none; width: 100%; text-align: left; cursor: pointer;
        border-radius: 15px;
    }
    .menu-item:active { background: rgba(0,0,0,0.05); }
    .menu-item i { font-size: 1.4rem; color: var(--text-sub); }
    .menu-item.red i, .menu-item.red { color: #ff6b6b; }

    /* Playlist List inside Modal */
    .pl-list { max-height: 200px; overflow-y: auto; text-align: left; margin: 10px 0; }
    .pl-item { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; }

    /* Desktop */
    @media (min-width: 768px) {
        .header, .music-list, .player-container { max-width: 800px; margin: 0 auto; }
        .player-container { bottom: 40px; }
        .player-card { flex-direction: row; text-align: left; max-width: 700px; }
        .player-title-row { width: 30%; margin-bottom: 0; }
        .progress-area { width: 40%; margin-bottom: 0; margin: 0 20px; }
        .controls-row { width: 30%; }
        /* Fix for playlist list scrolling on desktop */
        .music-list { overflow-y: auto; height: calc(100vh - 180px); }
    }
  </style>
</head>
<body>

  <!-- Top Navigation -->
  <div class="top-nav">
      <!-- Tab Switcher -->
      <div class="tabs-container">
          <button class="tab-btn active" id="tab-songs" onclick="switchTab('all')">Songs</button>
          <button class="tab-btn" id="tab-playlists" onclick="switchTab('playlists')">Playlists</button>
      </div>
      
      <!-- Right Icons -->
      <div class="top-icons">
          <button class="icon-circle" onclick="toggleTheme()"><i class="ri-moon-line" id="themeIcon"></i></button>
          <!-- Removed selection/list button -->
          <!-- Settings Icon (Upload for now) -->
          <a href="/postmp3" style="text-decoration:none;"><button class="icon-circle"><i class="ri-add-line"></i></button></a>
      </div>
  </div>

  <!-- Search Section (Cleaned) -->
  <div class="search-section" id="searchSection">
      <div class="search-bar-wrapper">
          <!-- Removed Mic Icon -->
          <input type="text" id="searchInput" class="search-input" placeholder="Search" oninput="filterSongs()">
      </div>
      <!-- Removed Filter Row -->
  </div>

  <!-- Song List -->
  <div class="music-list" id="musicContainer">
      <!-- Items Injected Here -->
  </div>

  <!-- Bottom Floating Player -->
  <div class="player-container">
      <div class="player-card">
          
          <!-- Title & Artist -->
          <div class="player-title-row">
              <div class="p-title" id="currentTrack">Select a track</div>
              <div class="p-artist" id="currentArtist">UNKNOWN</div>
          </div>

          <!-- Progress Bar -->
          <div class="progress-area">
              <div class="progress-bg"></div> <!-- Visual Track -->
              <input type="range" id="seekSlider" value="0" min="0" max="100" step="0.1">
              <div class="time-row">
                  <span id="currentTimeText">0:00</span>
                  <span id="totalTimeText">0:00</span>
              </div>
          </div>

          <!-- Controls -->
          <div class="controls-row">
              <button class="ctrl-btn-small" id="shuffleBtn"><i class="ri-shuffle-line"></i></button>
              <button class="ctrl-btn-med" id="prevBtn"><i class="ri-skip-back-fill"></i></button>
              
              <button class="play-btn-large" id="playPauseBtn">
                  <i class="ri-play-fill" style="margin-left: 5px;"></i> <!-- Offset for visual center -->
              </button>
              
              <button class="ctrl-btn-med" id="nextBtn"><i class="ri-skip-forward-fill"></i></button>
              <button class="ctrl-btn-small" id="loopBtn"><i class="ri-repeat-line"></i></button>
          </div>

      </div>
  </div>

  <audio id="audioPlayer"></audio>

  <!-- --- MODALS & MENUS --- -->

  <!-- 3 Dots Menu (Bottom Sheet) -->
  <div class="overlay" id="menuOverlay" onclick="closeMenu()">
      <div class="bottom-sheet" id="menuSheet" onclick="event.stopPropagation()">
          <h3 id="menuTitle" style="text-align:center; color:var(--text-main); margin-bottom:10px;">Options</h3>
          <button class="menu-item" onclick="menuAction('play')"><i class="ri-play-circle-line"></i> Play Now</button>
          <button class="menu-item" onclick="menuAction('queue')"><i class="ri-play-list-add-line"></i> Play Next</button>
          <button class="menu-item" onclick="menuAction('playlist')"><i class="ri-folder-add-line"></i> Add to Playlist</button>
          <button class="menu-item" onclick="menuAction('create')"><i class="ri-add-box-line"></i> Create Playlist</button>
          <button class="menu-item red" onclick="menuAction('delete')"><i class="ri-delete-bin-line"></i> Delete</button>
      </div>
  </div>

  <!-- Create Playlist Modal -->
  <div class="overlay" id="createModal">
      <div class="modal-box">
          <h3 style="margin:0; color:var(--text-main)">New Playlist</h3>
          <input type="text" id="newPlaylistName" placeholder="Playlist Name">
          <div class="modal-actions">
              <button class="tab-btn" onclick="document.getElementById('createModal').style.display='none'">Cancel</button>
              <button class="tab-btn active" onclick="confirmCreatePlaylist()">Create</button>
          </div>
      </div>
  </div>

  <!-- Add to Playlist Modal -->
  <div class="overlay" id="addModal">
      <div class="modal-box">
          <h3 style="margin:0; color:var(--text-main)">Add to Playlist</h3>
          <div class="pl-list" id="addToPlaylistList"></div>
          <button class="tab-btn" onclick="document.getElementById('addModal').style.display='none'" style="margin-top:10px;">Cancel</button>
      </div>
  </div>

  <!-- Selection Mode Actions (Shows at bottom when selecting) -->
  <div class="player-container" id="selectionBar" style="display:none; z-index:101;">
      <div class="player-card" style="flex-direction:row; justify-content:space-between;">
          <span id="selectCount" style="font-weight:600; color:var(--text-main)">0 Selected</span>
          <div style="display:flex; gap:10px;">
              <button class="tab-btn" onclick="toggleSelectionMode(false)">Cancel</button>
              <button class="tab-btn active" onclick="openCreateModal()">Save</button>
          </div>
      </div>
  </div>

  <script>
    // --- Data ---
    const rawFiles = <%- JSON.stringify(files) %>;
    
    // Process Data
    const allFiles = rawFiles.map(file => {
        const rawName = file.originalname.replace(/\.[^.]+$/, '');
        // Split by common separators to guess Artist - Title
        const parts = rawName.split(/[-_]/);
        let artist = "UNKNOWN";
        let title = rawName;
        
        if (parts.length > 1) {
            artist = parts[0].trim();
            title = parts.slice(1).join(' ').trim();
        }
        return { ...file, cleanTitle: title, cleanArtist: artist };
    }).sort((a, b) => a.cleanTitle.localeCompare(b.cleanTitle));

    // --- State ---
    let currentQueue = [...allFiles];
    let displayedFiles = [...allFiles]; // For search
    let currentTrackIndex = 0;
    let isPlaying = false;
    let isShuffle = false;
    let isLoop = false;
    let currentTab = 'all'; // 'all' or 'playlists' or 'single_playlist'
    let viewingPlaylistId = null;
    
    // Selection / Menu State
    let isSelectionMode = false;
    let selectedIndices = new Set();
    let menuTargetFile = null; // file object for context menu

    // Local Storage
    let savedPlaylists = JSON.parse(localStorage.getItem('vibePlaylists')) || [];

    // --- DOM ---
    const audioPlayer = document.getElementById('audioPlayer');
    const container = document.getElementById('musicContainer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const seekSlider = document.getElementById('seekSlider');
    
    // --- Render Functions ---

    function renderList() {
        // Toggle Search Visibility
        document.getElementById('searchSection').style.display = (currentTab === 'all') ? 'flex' : 'none';
        
        container.innerHTML = '';
        
        if (displayedFiles.length === 0 && currentTab === 'all') {
            container.innerHTML = `<p style="text-align:center; color:var(--text-sub); margin-top:50px;">No songs found</p>`;
            return;
        }

        const listToRender = (currentTab === 'all') ? displayedFiles : getPlaylistTracks();

        if (currentTab !== 'all' && listToRender.length === 0) {
             container.innerHTML = `<p style="text-align:center; color:var(--text-sub); margin-top:50px;">Empty Playlist</p>`;
             if (currentTab === 'single_playlist') {
                 container.innerHTML += `<div style="text-align:center;"><button class="tab-btn" style="color:red" onclick="deletePlaylist('${viewingPlaylistId}')">Delete Playlist</button></div>`;
             }
             return;
        }

        listToRender.forEach((file, index) => {
            // Find actual index in main array for selection logic
            const masterIndex = allFiles.findIndex(f => f.public_id === file.public_id);
            
            // Check active state
            const isCurrent = (currentQueue[currentTrackIndex]?.public_id === file.public_id);
            const activeClass = isCurrent ? 'active' : '';
            const icon = (isCurrent && isPlaying) ? '<i class="ri-pause-fill"></i>' : '<i class="ri-play-fill"></i>';
            
            // Selection logic
            const isSelected = selectedIndices.has(masterIndex);
            const checkIcon = isSelected ? '<i class="ri-checkbox-circle-fill" style="color:var(--accent-blue)"></i>' : '<i class="ri-checkbox-blank-circle-line"></i>';

            let leftIcon = `<div class="track-icon">${icon}</div>`;
            if (isSelectionMode) {
                leftIcon = `<div class="track-icon" style="background:transparent; color:var(--text-sub); font-size:1.5rem;">${checkIcon}</div>`;
            }

            const item = document.createElement('div');
            item.className = `track-item ${activeClass}`;
            item.onclick = () => handleItemClick(file, index, masterIndex);
            
            item.innerHTML = `
                ${leftIcon}
                <div class="track-details">
                    <div class="track-artist-small">${file.cleanArtist}</div>
                    <div class="track-name-large">${file.cleanTitle}</div>
                </div>
                ${!isSelectionMode ? 
                  `<button class="track-menu-btn" onclick="openMenu(event, '${file.public_id}')">
                      <i class="ri-more-2-fill"></i>
                   </button>` : ''}
            `;
            container.appendChild(item);
        });
        
        // Add padding at bottom for player
        const spacer = document.createElement('div');
        spacer.style.height = '120px';
        container.appendChild(spacer);
    }

    function renderPlaylists() {
        document.getElementById('searchSection').style.display = 'none';
        container.innerHTML = '';
        
        if(savedPlaylists.length === 0) {
            container.innerHTML = `<div style="text-align:center; margin-top:50px; color:var(--text-sub);">
                <p>No playlists yet</p>
                <button class="tab-btn active" onclick="openCreateModal()">Create New</button>
            </div>`;
            return;
        }

        savedPlaylists.forEach(pl => {
            const div = document.createElement('div');
            div.className = 'track-item'; // Reuse styling
            div.onclick = () => openPlaylistView(pl.id);
            div.innerHTML = `
                <div class="track-icon" style="background:var(--accent-light); color:var(--accent-blue)">
                    <i class="ri-play-list-2-fill"></i>
                </div>
                <div class="track-details">
                    <div class="track-artist-small">PLAYLIST</div>
                    <div class="track-name-large">${pl.name}</div>
                </div>
                <div style="font-weight:600; color:var(--text-sub); margin-right:10px;">${pl.fileIds.length} Songs</div>
                <i class="ri-arrow-right-s-line" style="color:var(--text-sub)"></i>
            `;
            container.appendChild(div);
        });
    }

    // --- Actions ---

    function handleItemClick(file, index, masterIndex) {
        if (isSelectionMode) {
            if (selectedIndices.has(masterIndex)) selectedIndices.delete(masterIndex);
            else selectedIndices.add(masterIndex);
            document.getElementById('selectCount').textContent = `${selectedIndices.size} Selected`;
            renderList();
            return;
        }
        
        // Play Logic
        if (currentTab === 'all') {
            currentQueue = [...displayedFiles];
            playTrack(index); // Index matches displayedFiles
        } else if (currentTab === 'single_playlist') {
            currentQueue = getPlaylistTracks();
            playTrack(index);
        }
    }

    function playTrack(index) {
        if (index < 0 || index >= currentQueue.length) return;
        currentTrackIndex = index;
        const song = currentQueue[index];
        
        if(audioPlayer.src !== song.url) {
            audioPlayer.src = song.url;
            // Also update slider visual to 0 immediately
            seekSlider.value = 0;
            updateSliderFill(0);
        }
        
        // Update Player UI
        document.getElementById('currentTrack').textContent = song.cleanTitle;
        document.getElementById('currentArtist').textContent = song.cleanArtist;
        
        audioPlayer.play().catch(e => console.log("Play error", e));
        isPlaying = true;
        updatePlayBtn();
        renderList(); // Update icons
    }

    function updatePlayBtn() {
        playPauseBtn.innerHTML = isPlaying ? 
            '<i class="ri-pause-fill" style="margin-left:0"></i>' : 
            '<i class="ri-play-fill" style="margin-left:5px"></i>';
    }

    // --- Search ---
    function filterSongs() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        displayedFiles = allFiles.filter(f => f.cleanTitle.toLowerCase().includes(q) || f.cleanArtist.toLowerCase().includes(q));
        renderList();
    }

    // --- Menu Logic ---
    function openMenu(e, id) {
        e.stopPropagation();
        menuTargetFile = allFiles.find(f => f.public_id === id);
        if(!menuTargetFile) return;
        
        document.getElementById('menuTitle').textContent = menuTargetFile.cleanTitle;
        document.getElementById('menuOverlay').style.display = 'flex';
        setTimeout(() => document.getElementById('menuSheet').style.bottom = '0', 10);
    }

    function closeMenu() {
        document.getElementById('menuSheet').style.bottom = '-100%';
        setTimeout(() => document.getElementById('menuOverlay').style.display = 'none', 300);
    }

    function menuAction(action) {
        closeMenu();
        if (!menuTargetFile) return;

        if (action === 'play') {
            // Play immediately (switch to all context if needed)
            const idx = allFiles.findIndex(f => f.public_id === menuTargetFile.public_id);
            currentQueue = [...allFiles];
            playTrack(idx);
        } else if (action === 'queue') {
            currentQueue.splice(currentTrackIndex + 1, 0, menuTargetFile);
            alert("Added to queue");
        } else if (action === 'delete') {
            if(confirm("Delete permanently?")) window.location.href = `/AllBus/${menuTargetFile.public_id.split('/').pop()}`;
        } else if (action === 'create') {
            selectedIndices.clear();
            const idx = allFiles.findIndex(f => f.public_id === menuTargetFile.public_id);
            selectedIndices.add(idx);
            openCreateModal();
        } else if (action === 'playlist') {
            openAddToPlaylistModal(menuTargetFile.public_id);
        }
    }

    // --- Modal Logic ---
    function openCreateModal() {
        document.getElementById('createModal').style.display = 'flex';
    }

    function confirmCreatePlaylist() {
        const name = document.getElementById('newPlaylistName').value || "New Playlist";
        // If selection mode active, use selected indices. Else use menu target if exists.
        let ids = [];
        if (isSelectionMode) {
            ids = Array.from(selectedIndices).map(i => allFiles[i].public_id);
        } else if (menuTargetFile) {
            ids = [menuTargetFile.public_id];
        } else if (savedPlaylists.length === 0 && currentTab === 'playlists') {
             // Creating empty playlist from empty state
             ids = []; 
        }

        const newPl = { id: Date.now().toString(), name, fileIds: ids };
        savedPlaylists.push(newPl);
        localStorage.setItem('vibePlaylists', JSON.stringify(savedPlaylists));
        
        document.getElementById('createModal').style.display = 'none';
        toggleSelectionMode(false);
        switchTab('playlists');
    }

    function openAddToPlaylistModal(fileId) {
        if(savedPlaylists.length === 0) return alert("Create a playlist first");
        const list = document.getElementById('addToPlaylistList');
        list.innerHTML = '';
        savedPlaylists.forEach(pl => {
            const d = document.createElement('div');
            d.className = 'pl-item';
            d.textContent = pl.name;
            d.onclick = () => {
                pl.fileIds.push(fileId);
                localStorage.setItem('vibePlaylists', JSON.stringify(savedPlaylists));
                document.getElementById('addModal').style.display = 'none';
                alert("Added!");
            };
            list.appendChild(d);
        });
        document.getElementById('addModal').style.display = 'flex';
    }

    // --- Tab Switching ---
    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('tab-songs').className = (tab === 'all') ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-playlists').className = (tab === 'playlists' || tab === 'single_playlist') ? 'tab-btn active' : 'tab-btn';
        
        // Hide selection bar if switching away
        if(isSelectionMode) toggleSelectionMode(false);

        if (tab === 'all') renderList();
        else renderPlaylists();
    }

    function openPlaylistView(id) {
        viewingPlaylistId = id;
        currentTab = 'single_playlist';
        // Add back button logic visually by changing header? 
        // For simplicity, reusing list container.
        renderList(); 
    }
    
    function getPlaylistTracks() {
        const pl = savedPlaylists.find(p => p.id === viewingPlaylistId);
        if(!pl) return [];
        return pl.fileIds.map(id => allFiles.find(f => f.public_id === id)).filter(Boolean);
    }
    
    function deletePlaylist(id) {
        if(confirm("Delete playlist?")) {
            savedPlaylists = savedPlaylists.filter(p => p.id !== id);
            localStorage.setItem('vibePlaylists', JSON.stringify(savedPlaylists));
            switchTab('playlists');
        }
    }

    // --- Selection Mode ---
    function toggleSelectionMode(forceState) {
        isSelectionMode = forceState;
        selectedIndices.clear();
        document.getElementById('selectionBar').style.display = isSelectionMode ? 'flex' : 'none';
        
        // If selection mode is on, hide the main player
        const mainPlayer = document.querySelector('.player-container:not(#selectionBar)');
        if(mainPlayer) mainPlayer.style.display = isSelectionMode ? 'none' : 'flex';
        
        renderList();
    }

    // --- Audio Events ---
    playPauseBtn.onclick = () => {
        if (!audioPlayer.src && currentQueue.length > 0) playTrack(0);
        else if (isPlaying) { audioPlayer.pause(); isPlaying = false; }
        else { audioPlayer.play(); isPlaying = true; }
        updatePlayBtn();
        renderList();
    };

    document.getElementById('nextBtn').onclick = () => {
        let next = isShuffle ? Math.floor(Math.random()*currentQueue.length) : (currentTrackIndex + 1) % currentQueue.length;
        playTrack(next);
    };
    
    document.getElementById('prevBtn').onclick = () => {
        let prev = (currentTrackIndex - 1 + currentQueue.length) % currentQueue.length;
        playTrack(prev);
    };

    document.getElementById('shuffleBtn').onclick = function() {
        isShuffle = !isShuffle;
        this.className = isShuffle ? 'ctrl-btn-small active' : 'ctrl-btn-small';
    };
    document.getElementById('loopBtn').onclick = function() {
        isLoop = !isLoop;
        this.className = isLoop ? 'ctrl-btn-small active' : 'ctrl-btn-small';
    };

    audioPlayer.onended = () => {
        if(isLoop) { audioPlayer.currentTime = 0; audioPlayer.play(); }
        else document.getElementById('nextBtn').click();
    };

    // Timeline
    audioPlayer.ontimeupdate = () => {
        if (audioPlayer.duration) {
            const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            seekSlider.value = pct;
            updateSliderFill(pct);
            document.getElementById('currentTimeText').innerText = formatTime(audioPlayer.currentTime);
            document.getElementById('totalTimeText').innerText = formatTime(audioPlayer.duration);
        }
    };
    
    seekSlider.oninput = () => {
        const time = (seekSlider.value / 100) * audioPlayer.duration;
        audioPlayer.currentTime = time;
        updateSliderFill(seekSlider.value);
    };

    function updateSliderFill(val) {
        // Gradient fill for input range
        const blue = getComputedStyle(document.body).getPropertyValue('--accent-blue').trim();
        seekSlider.style.background = `linear-gradient(to right, ${blue} 0%, ${blue} ${val}%, rgba(91,141,239,0.15) ${val}%, rgba(91,141,239,0.15) 100%)`;
    }

    function formatTime(s) {
        if(!s) return "0:00";
        const m = Math.floor(s/60);
        const sec = Math.floor(s%60);
        return m + ":" + (sec < 10 ? "0"+sec : sec);
    }

    // Theme Toggle
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('themeIcon').className = isDark ? 'ri-sun-fill' : 'ri-moon-fill';
        localStorage.setItem('vibeTheme', isDark ? 'dark' : 'light');
    }
    if (localStorage.getItem('vibeTheme') === 'dark') toggleTheme();

    // Init
    renderList();

  </script>
</body>
</html>
