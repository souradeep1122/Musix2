<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Vibe Music Player</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet"/>
  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- Exact Reference Theming --- */
    :root {
      /* Light Mode Palette */
      --text-main: #333333;
      --text-sub: #888888;
      
      --accent-blue: #5B8DEF; 
      --accent-light: #DCE8F9;
      
      --card-bg: rgba(255, 255, 255, 0.7);
      --glass-border: 1px solid rgba(255, 255, 255, 0.5);
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.05);
      
      --tab-bg: #FFFFFF;
      --tab-active-bg: #5B8DEF;
      --tab-active-text: #FFFFFF;
      
      --search-bg: #FFFFFF;
      
      --track-icon-bg: #FFFFFF;
      --track-icon-color: #5B8DEF;
      
      --player-bg: rgba(255, 255, 255, 0.9);
      --player-shadow: 0 -10px 40px rgba(91, 141, 239, 0.15);
      
      /* SVG Background Data URI for Light Mode (Wavy Lines) */
      --bg-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 1200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23FDFBF7;stop-opacity:1' /%3E%3Cstop offset='40%25' style='stop-color:%23F4F7F6;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23DCE8F9;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23grad)'/%3E%3Cg fill='none' stroke='%235B8DEF' stroke-width='1' stroke-opacity='0.15'%3E%3Cpath d='M-100 600 C 200 500, 600 800, 900 700' /%3E%3Cpath d='M-100 620 C 200 520, 600 820, 900 720' /%3E%3Cpath d='M-100 640 C 200 540, 600 840, 900 740' /%3E%3Cpath d='M-100 660 C 200 560, 600 860, 900 760' /%3E%3Cpath d='M-100 680 C 200 580, 600 880, 900 780' /%3E%3Cpath d='M-100 700 C 200 600, 600 900, 900 800' /%3E%3Cpath d='M-100 720 C 200 620, 600 920, 900 820' /%3E%3Cpath d='M-100 740 C 200 640, 600 940, 900 840' /%3E%3Cpath d='M-100 760 C 200 660, 600 960, 900 860' /%3E%3C/g%3E%3C/svg%3E");
    }

    body.dark-mode {
      /* Dark Mode Palette */
      --text-main: #FFFFFF;
      --text-sub: #8892B0;
      
      --accent-blue: #5B8DEF;
      --accent-light: rgba(91, 141, 239, 0.2);
      
      --card-bg: rgba(30, 32, 40, 0.6);
      --glass-border: 1px solid rgba(255, 255, 255, 0.05);
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.3);
      
      --tab-bg: #252830;
      --tab-active-bg: #353945;
      --tab-active-text: #FFFFFF;
      
      --search-bg: #252830;
      
      --track-icon-bg: #2C303A;
      --track-icon-color: #5B8DEF;
      
      --player-bg: rgba(20, 22, 28, 0.95);
      --player-shadow: 0 -10px 40px rgba(0,0,0,0.5);

      /* SVG Background Data URI for Dark Mode (Neon Waves) */
      --bg-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 1200'%3E%3Cdefs%3E%3ClinearGradient id='grad-dark' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%230F1520;stop-opacity:1' /%3E%3Cstop offset='50%25' style='stop-color:%2318202F;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23253045;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23grad-dark)'/%3E%3Cg fill='none' stroke='%2300C2FF' stroke-width='1.5' stroke-opacity='0.3'%3E%3Cpath d='M-100 600 C 200 500, 600 800, 900 700' /%3E%3Cpath d='M-100 620 C 200 520, 600 820, 900 720' /%3E%3Cpath d='M-100 640 C 200 540, 600 840, 900 740' /%3E%3Cpath d='M-100 660 C 200 560, 600 860, 900 760' /%3E%3Cpath d='M-100 680 C 200 580, 600 880, 900 780' /%3E%3Cpath d='M-100 700 C 200 600, 600 900, 900 800' /%3E%3Cpath d='M-100 720 C 200 620, 600 920, 900 820' /%3E%3Cpath d='M-100 740 C 200 640, 600 940, 900 840' /%3E%3Cpath d='M-100 760 C 200 660, 600 960, 900 860' /%3E%3C/g%3E%3C/svg%3E");
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      background-image: var(--bg-image);
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      color: var(--text-main);
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: color 0.3s ease;
    }

    /* --- Top Navigation Area --- */
    .top-nav {
      padding: 40px 20px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .header-left {
        display: flex;
        flex-direction: column;
    }
    
    .song-count-badge {
        font-size: 0.75rem;
        color: var(--text-sub);
        font-weight: 600;
        margin-top: 4px;
        margin-left: 8px;
    }

    /* Pill Tabs */
    .tabs-container {
      background: var(--tab-bg);
      border-radius: 30px;
      padding: 4px;
      display: flex;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }

    .tab-btn {
      padding: 8px 24px;
      border-radius: 25px;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      background: transparent;
      color: var(--text-sub);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      background: var(--tab-active-bg);
      color: var(--tab-active-text);
      box-shadow: 0 4px 12px rgba(91, 141, 239, 0.3);
    }

    /* Top Right Icons */
    .top-icons {
      display: flex;
      gap: 12px;
    }

    .icon-circle {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: var(--tab-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-blue);
      font-size: 1.2rem;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      transition: transform 0.2s;
    }
    .icon-circle:active { transform: scale(0.95); }

    /* --- Search Section --- */
    .search-section {
      padding: 5px 20px 15px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 9;
    }

    .search-bar-wrapper {
      position: relative;
      width: 100%;
    }

    .search-input {
      width: 100%;
      background: var(--search-bg);
      border: none;
      padding: 14px 20px;
      border-radius: 20px;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: var(--text-main);
      box-shadow: 0 2px 10px rgba(0,0,0,0.02);
    }
    
    /* --- Song List --- */
    .music-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 20px 220px;
      scrollbar-width: none;
    }
    .music-list::-webkit-scrollbar { display: none; }

    .track-item {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      cursor: pointer;
      position: relative;
    }

    /* Play Icon Circle */
    .track-icon {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      background: var(--track-icon-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--track-icon-color);
      font-size: 1.2rem;
      flex-shrink: 0;
      margin-right: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    }

    .track-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .track-artist-small {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-sub);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }

    .track-name-large {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-menu-btn {
      padding: 10px;
      background: transparent;
      border: none;
      color: var(--text-sub);
      font-size: 1.4rem;
      cursor: pointer;
    }
    
    .playlist-header-card {
        background: var(--accent-light);
        padding: 20px;
        border-radius: 25px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .playlist-info h2 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--text-main);
    }
    .playlist-info p {
        margin: 5px 0 0;
        font-size: 0.8rem;
        color: var(--text-sub);
    }
    
    .playlist-actions {
        display: flex;
        gap: 10px;
    }
    .pl-action-btn {
        background: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: var(--text-sub);
        font-size: 1.2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .track-item.active .track-icon {
        background: var(--accent-blue);
        color: #fff;
        box-shadow: 0 4px 15px rgba(91, 141, 239, 0.4);
    }
    
    .track-item.active .track-name-large {
        color: var(--accent-blue);
    }

    /* --- Bottom Player (COMPACT VERSION) --- */
    .player-container {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      z-index: 100;
    }

    .player-card {
      background: var(--player-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 35px;
      padding: 15px 25px; /* Compact padding */
      box-shadow: var(--player-shadow);
      border: var(--glass-border);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .player-title-row {
      margin-bottom: 10px; /* Reduced margin */
      width: 100%;
    }

    .p-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .p-artist {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-sub);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Progress Bar */
    .progress-area {
      width: 100%;
      margin-bottom: 15px; /* Reduced margin */
      position: relative;
    }

    .progress-bg {
      width: 100%;
      height: 5px;
      background: rgba(91, 141, 239, 0.15);
      border-radius: 10px;
    }

    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 5px;
      background: transparent;
      position: absolute;
      top: 0; left: 0;
      margin: 0;
      cursor: pointer;
    }

    input[type=range]:focus { outline: none; }

    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 16px; 
        width: 16px; 
        border-radius: 50%;
        background: #FFFFFF;
        border: 1px solid rgba(0,0,0,0.1);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        margin-top: -6px;
    }
    
    .time-row {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-sub);
    }

    /* Controls */
    .controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0 10px;
    }

    .ctrl-btn-small {
      background: transparent;
      border: none;
      color: var(--accent-blue);
      font-size: 1.3rem;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .ctrl-btn-small:hover { opacity: 1; }
    .ctrl-btn-small.active { opacity: 1; text-shadow: 0 0 10px var(--accent-blue); }

    .ctrl-btn-med {
        background: transparent;
        border: none;
        color: var(--accent-blue);
        font-size: 1.6rem;
        cursor: pointer;
    }

    .play-btn-large {
      width: 60px; /* Reduced from 70px */
      height: 60px; 
      border-radius: 50%;
      background: #FFFFFF;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-blue);
      font-size: 1.8rem;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .play-btn-large:active { transform: scale(0.95); }
    
    body.dark-mode .play-btn-large {
        background: #2C303A;
        color: #5B8DEF;
        box-shadow: 0 5px 20px rgba(0,0,0,0.4);
    }

    /* Visitor Counter */
    .visitor-footer {
        padding: 20px;
        text-align: center;
        color: var(--text-sub);
        font-size: 0.75rem;
        font-weight: 500;
        letter-spacing: 0.5px;
        opacity: 0.8;
    }

    /* --- Modals & Sheets --- */
    .overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 200; display: none;
        align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    
    .modal-box {
        background: var(--tab-bg);
        padding: 30px; border-radius: 25px; width: 85%; max-width: 320px;
        text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }
    .modal-box input {
        width: 100%; padding: 12px; margin: 15px 0; border-radius: 12px;
        border: 1px solid rgba(0,0,0,0.1); background: rgba(0,0,0,0.05);
        color: var(--text-main);
    }
    .modal-actions { display: flex; gap: 15px; justify-content: center; }
    
    /* Bottom Sheet */
    .bottom-sheet {
        position: fixed; bottom: -100%; left: 0; width: 100%;
        background: var(--tab-bg);
        border-radius: 30px 30px 0 0; padding: 25px 25px 40px;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
        transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 201; display: flex; flex-direction: column; gap: 8px;
    }
    .menu-item {
        padding: 15px; display: flex; gap: 15px; align-items: center;
        font-size: 1rem; color: var(--text-main); background: transparent;
        border: none; width: 100%; text-align: left; cursor: pointer;
        border-radius: 15px;
    }
    .menu-item:active { background: rgba(0,0,0,0.05); }
    .menu-item i { font-size: 1.4rem; color: var(--text-sub); }
    .menu-item.red i, .menu-item.red { color: #ff6b6b; }

    .pl-list { max-height: 200px; overflow-y: auto; text-align: left; margin: 10px 0; }
    .pl-item { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; color: var(--text-main); }

    /* Desktop Fix */
    @media (min-width: 768px) {
        .header, .music-list, .player-container, .search-section, .top-nav { max-width: 800px; margin: 0 auto; }
        .player-container { bottom: 40px; }
        .player-card { flex-direction: row; text-align: left; max-width: 700px; padding: 15px 30px; }
        .player-title-row { width: 30%; margin-bottom: 0; }
        .progress-area { width: 40%; margin-bottom: 0; margin: 0 20px; }
        .controls-row { width: 30%; }
        .music-list { overflow-y: auto; height: calc(100vh - 200px); padding-bottom: 120px; }
    }
  </style>
</head>
<body>

  <!-- Top Navigation -->
  <div class="top-nav">
      <div class="header-left">
        <div class="tabs-container">
            <button class="tab-btn active" id="tab-songs" onclick="switchTab('all')">Songs</button>
            <button class="tab-btn" id="tab-playlists" onclick="switchTab('playlists')">Playlists</button>
        </div>
        <div class="song-count-badge" id="totalSongsCount">0 Songs</div>
      </div>
      
      <div class="top-icons">
          <button class="icon-circle" onclick="toggleTheme()"><i class="ri-moon-line" id="themeIcon"></i></button>
          <a href="/postmp3" style="text-decoration:none;"><button class="icon-circle"><i class="ri-add-line"></i></button></a>
      </div>
  </div>

  <!-- Search Section -->
  <div class="search-section" id="searchSection">
      <div class="search-bar-wrapper">
          <input type="text" id="searchInput" class="search-input" placeholder="Search" oninput="filterSongs()">
      </div>
  </div>

  <!-- Song List -->
  <div class="music-list" id="musicContainer">
      <!-- Items Injected Here -->
  </div>

  <!-- Bottom Floating Player -->
  <div class="player-container">
      <div class="player-card">
          
          <div class="player-title-row">
              <div class="p-title" id="currentTrack">Select a track</div>
              <div class="p-artist" id="currentArtist">UNKNOWN</div>
          </div>

          <div class="progress-area">
              <div class="progress-bg"></div>
              <input type="range" id="seekSlider" value="0" min="0" max="100" step="0.1">
              <div class="time-row">
                  <span id="currentTimeText">0:00</span>
                  <span id="totalTimeText">0:00</span>
              </div>
          </div>

          <div class="controls-row">
              <button class="ctrl-btn-small" id="shuffleBtn"><i class="ri-shuffle-line"></i></button>
              <button class="ctrl-btn-med" id="prevBtn"><i class="ri-skip-back-fill"></i></button>
              
              <button class="play-btn-large" id="playPauseBtn">
                  <i class="ri-play-fill" style="margin-left: 5px;"></i>
              </button>
              
              <button class="ctrl-btn-med" id="nextBtn"><i class="ri-skip-forward-fill"></i></button>
              <button class="ctrl-btn-small" id="loopBtn"><i class="ri-repeat-line"></i></button>
          </div>

      </div>
  </div>

  <audio id="audioPlayer"></audio>

  <!-- --- MODALS & MENUS --- -->

  <!-- Dynamic Bottom Menu -->
  <div class="overlay" id="menuOverlay" onclick="closeMenu()">
      <div class="bottom-sheet" id="menuSheet" onclick="event.stopPropagation()">
          <h3 id="menuTitle" style="text-align:center; color:var(--text-main); margin-bottom:10px;">Options</h3>
          
          <button class="menu-item" onclick="menuAction('play')">
            <i class="ri-play-circle-line"></i> Play Now
          </button>
          <button class="menu-item" onclick="menuAction('queue')">
            <i class="ri-play-list-add-line"></i> Play Next
          </button>
          
          <!-- Context Aware Buttons -->
          <div id="contextMenuOptions"></div>

      </div>
  </div>

  <!-- Create/Rename Playlist Modal -->
  <div class="overlay" id="createModal">
      <div class="modal-box">
          <h3 style="margin:0; color:var(--text-main)" id="createModalTitle">New Playlist</h3>
          <input type="text" id="newPlaylistName" placeholder="Playlist Name">
          <div class="modal-actions">
              <button class="tab-btn" onclick="document.getElementById('createModal').style.display='none'">Cancel</button>
              <button class="tab-btn active" onclick="confirmPlaylistAction()">Save</button>
          </div>
      </div>
  </div>

  <!-- Add To Playlist Modal -->
  <div class="overlay" id="addModal">
      <div class="modal-box">
          <h3 style="margin:0; color:var(--text-main)">Add to Playlist</h3>
          <div class="pl-list" id="addToPlaylistList"></div>
          <button class="tab-btn" onclick="document.getElementById('addModal').style.display='none'" style="margin-top:10px;">Cancel</button>
      </div>
  </div>

  <script>
    const rawFiles = <%- JSON.stringify(files) %>;
    const visitCount = <%= typeof visitorCount !== 'undefined' ? visitorCount : '0' %>;

    // --- METADATA PARSER HELPER ---
    function parseMetadata(filename) {
        let name = filename;

        // 1. Decode URI components (fixes %E2%80%93 etc.)
        try { name = decodeURIComponent(name); } catch (e) {}

        // 2. Remove Extension
        name = name.replace(/\.[^.]+$/, '');

        // 3. Fix Encoding Artifacts (Common MOJIBAKE for dashes)
        // â is often a CP1252 to UTF-8 mess up of en-dash
        name = name.replace(/â/g, '-').replace(/â/g, '-').replace(/â/g, ''); 

        // 4. Normalize Dashes and Underscores
        name = name.replace(/[\u2013\u2014\u2212]/g, '-');
        name = name.replace(/_/g, ' '); // Convert underscores to spaces

        // 5. Smart Cleaning (Regex)
        // Strategy: Only remove specific "meta" terms if they are inside brackets/parentheses OR at the very end of the string.
        
        // Remove things inside brackets () or [] if they contain "junk" keywords
        // e.g. (Official Video), [4K], (Lyrics), (256kbps)
        name = name.replace(/\s*[(\[][^)\]]*(official|video|lyrics|visualizer|audio|kbps|\d+k|www\.|@)[^)\]]*[)\]]/gi, '');

        // Remove trailing years e.g. (2017) or 2017 at the end
        name = name.replace(/\s*\(?\d{4}\)?\s*$/g, '');

        // Remove specific phrases ONLY at the end of the string case-insensitive
        // This prevents removing "Video" from "Video Games"
        const phrases = [
            'official video', 'music video', 'lyric video', 'visualizer', 
            'official audio', 'with lyrics', 'lyrics', 'video', 'audio', 
            'full song', 'hd', 'hq', '4k'
        ];
        
        // Loop twice to catch combinations like "Official Video Lyrics"
        for(let i=0; i<2; i++) {
            phrases.forEach(phrase => {
                // Regex: Phrase at the end, optional parens/brackets
                const regex = new RegExp(`\\s*[(\\[-]?\\s*${phrase}\\s*[)\\]]?\\s*$`, 'gi');
                name = name.replace(regex, '');
            });
        }

        // Remove Bitrates (128kbps, 320kbps, 256k) if loose in string
        name = name.replace(/\s*-?\s*\(?\d+\s*(kbps|k)\)?/gi, '');

        // 6. Cleanup Formatting
        name = name.replace(/\s+/g, ' ').trim(); // Collapse spaces
        name = name.replace(/^[-–—\s]+|[-–—\s]+$/g, ''); // Trim dashes/spaces from ends
        name = name.replace(/\(\s*\)/g, '').replace(/\[\s*\]/g, ''); // Remove empty brackets

        // 7. Split Logic
        let artist = "UNKNOWN";
        let title = name;

        // Pattern 1: "Artist - Title"
        if (name.includes(' - ')) {
            const parts = name.split(' - ');
            artist = parts[0].trim();
            title = parts.slice(1).join(' - ').trim();
        } 
        // Pattern 2: "Title by Artist"
        else if (name.includes(' by ')) {
            const parts = name.split(' by ');
            title = parts[0].trim();
            artist = parts[1].trim();
        }
        
        return { artist, title };
    }

    const allFiles = rawFiles.map(file => {
        const meta = parseMetadata(file.originalname);
        return { ...file, cleanTitle: meta.title, cleanArtist: meta.artist };
    }).sort((a, b) => a.cleanTitle.localeCompare(b.cleanTitle));

    // --- STATE MANAGEMENT ---
    let currentQueue = [...allFiles];
    let displayedFiles = [...allFiles]; 
    let currentTrackIndex = 0;
    let isPlaying = false;
    let isShuffle = false;
    let isLoop = false;
    let currentTab = 'all'; 
    let viewingPlaylistId = null;
    let menuTargetFile = null; 
    let playlistActionMode = 'create'; // 'create' or 'rename'

    let savedPlaylists = JSON.parse(localStorage.getItem('vibePlaylists')) || [];

    // --- DOM ELEMENTS ---
    const audioPlayer = document.getElementById('audioPlayer');
    const container = document.getElementById('musicContainer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const seekSlider = document.getElementById('seekSlider');
    const totalCountEl = document.getElementById('totalSongsCount');
    
    // --- INITIALIZATION ---
    function updateGlobalSongCount() {
        totalCountEl.textContent = `${allFiles.length} Songs`;
    }

    // --- CORE RENDERING ---
    function renderList() {
        // Toggle Search Visibility
        document.getElementById('searchSection').style.display = (currentTab === 'all') ? 'flex' : 'none';
        container.innerHTML = '';
        
        // 1. ALL SONGS VIEW
        if (currentTab === 'all') {
            updateGlobalSongCount();
            if (displayedFiles.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:var(--text-sub); margin-top:50px;">No songs found</p>`;
                return;
            }
            renderTracks(displayedFiles);
        } 
        
        // 2. PLAYLIST LIST VIEW
        else if (currentTab === 'playlists') {
            totalCountEl.textContent = `${savedPlaylists.length} Playlists`;
            renderPlaylistsView();
        } 
        
        // 3. SINGLE PLAYLIST DETAILS VIEW
        else if (currentTab === 'single_playlist') {
            const pl = savedPlaylists.find(p => p.id === viewingPlaylistId);
            if (!pl) { switchTab('playlists'); return; } // Safety
            
            const plTracks = getPlaylistTracks(pl.id);
            totalCountEl.textContent = `${plTracks.length} Songs`;

            // Render Playlist Header
            const header = document.createElement('div');
            header.className = 'playlist-header-card';
            header.innerHTML = `
                <div class="playlist-info">
                    <h2>${pl.name}</h2>
                    <p>${plTracks.length} Tracks • Local Playlist</p>
                </div>
                <div class="playlist-actions">
                    <button class="pl-action-btn" onclick="openRenameModal('${pl.id}')"><i class="ri-edit-2-line"></i></button>
                    <button class="pl-action-btn" style="color:#ff6b6b" onclick="deletePlaylist('${pl.id}')"><i class="ri-delete-bin-line"></i></button>
                </div>
            `;
            container.appendChild(header);

            if (plTracks.length === 0) {
                container.innerHTML += `<div style="text-align:center; padding: 40px; color:var(--text-sub);">
                    <i class="ri-music-2-line" style="font-size: 3rem; opacity:0.3"></i>
                    <p>Playlist is empty</p>
                    <button class="tab-btn active" onclick="switchTab('all')">Add Songs</button>
                </div>`;
            } else {
                renderTracks(plTracks);
            }
        }

        // Add Spacer for Bottom Player
        const spacer = document.createElement('div');
        spacer.style.height = '120px';
        container.appendChild(spacer);
    }

    function renderTracks(list) {
        list.forEach((file, index) => {
            // Check if this specific file is the currently playing one
            // We compare IDs because index changes between playlists/all views
            const isCurrent = (currentQueue[currentTrackIndex]?.public_id === file.public_id);
            const activeClass = isCurrent ? 'active' : '';
            const icon = (isCurrent && isPlaying) ? '<i class="ri-pause-fill"></i>' : '<i class="ri-play-fill"></i>';
            
            const item = document.createElement('div');
            item.className = `track-item ${activeClass}`;
            // Use closure to capture the correct file object for playing
            item.onclick = () => handleItemClick(file); 
            
            item.innerHTML = `
                <div class="track-icon">${icon}</div>
                <div class="track-details">
                    <div class="track-artist-small">${file.cleanArtist}</div>
                    <div class="track-name-large">${file.cleanTitle}</div>
                </div>
                <button class="track-menu-btn" onclick="openMenu(event, '${file.public_id}')">
                    <i class="ri-more-2-fill"></i>
                </button>
            `;
            container.appendChild(item);
        });

        if (currentTab === 'all') {
             // Visitor footer only on main list
             const footer = document.createElement('div');
             footer.className = 'visitor-footer';
             footer.innerHTML = `Vibe Player • ${visitCount} Total Visits`;
             container.appendChild(footer);
        }
    }

    function renderPlaylistsView() {
        if(savedPlaylists.length === 0) {
            container.innerHTML = `<div style="text-align:center; margin-top:50px; color:var(--text-sub);">
                <i class="ri-play-list-add-line" style="font-size: 3rem; opacity:0.3; margin-bottom:10px; display:block"></i>
                <p>No playlists yet</p>
                <button class="tab-btn active" onclick="openCreateModal()">Create New</button>
            </div>`;
            return;
        }

        savedPlaylists.forEach(pl => {
            const div = document.createElement('div');
            div.className = 'track-item'; 
            div.onclick = () => openPlaylistView(pl.id);
            div.innerHTML = `
                <div class="track-icon" style="background:var(--accent-light); color:var(--accent-blue)">
                    <i class="ri-play-list-2-fill"></i>
                </div>
                <div class="track-details">
                    <div class="track-artist-small">PLAYLIST</div>
                    <div class="track-name-large">${pl.name}</div>
                </div>
                <div style="font-weight:600; color:var(--text-sub); margin-right:10px;">${pl.fileIds.length} Songs</div>
                <i class="ri-arrow-right-s-line" style="color:var(--text-sub)"></i>
            `;
            container.appendChild(div);
        });
    }

    // --- LOGIC: CLICK & PLAY ---
    function handleItemClick(file) {
        // If clicking inside a playlist, we want the queue to be that playlist
        // If clicking in 'all', queue is all
        
        let newQueue = [];
        if (currentTab === 'all') newQueue = [...displayedFiles];
        else if (currentTab === 'single_playlist') newQueue = getPlaylistTracks(viewingPlaylistId);
        
        // Find index in the NEW queue
        const idx = newQueue.findIndex(f => f.public_id === file.public_id);
        
        currentQueue = newQueue;
        playTrack(idx);
    }

    function playTrack(index) {
        if (index < 0 || index >= currentQueue.length) return;
        currentTrackIndex = index;
        const song = currentQueue[index];
        
        if(audioPlayer.src !== song.url) {
            audioPlayer.src = song.url;
            seekSlider.value = 0;
            updateSliderFill(0);
        }
        
        document.getElementById('currentTrack').textContent = song.cleanTitle;
        document.getElementById('currentArtist').textContent = song.cleanArtist;
        
        audioPlayer.play().catch(e => console.log("Play error", e));
        isPlaying = true;
        updatePlayBtn();
        renderList(); // Re-render to show active state
    }

    // --- MENU SYSTEM ---
    function openMenu(e, id) {
        e.stopPropagation();
        menuTargetFile = allFiles.find(f => f.public_id === id);
        if(!menuTargetFile) return;
        
        document.getElementById('menuTitle').textContent = menuTargetFile.cleanTitle;
        
        // Inject Context-Aware Options
        const ctxContainer = document.getElementById('contextMenuOptions');
        ctxContainer.innerHTML = '';
        
        if (currentTab === 'single_playlist') {
            // We are in a playlist -> Show Remove Option
            ctxContainer.innerHTML += `
                <button class="menu-item red" onclick="menuAction('remove_from_pl')">
                    <i class="ri-indeterminate-circle-line"></i> Remove from Playlist
                </button>
            `;
        } else {
            // We are in All Songs -> Show Add & Delete Option
            ctxContainer.innerHTML += `
                <button class="menu-item" onclick="menuAction('playlist')">
                    <i class="ri-folder-add-line"></i> Add to Playlist
                </button>
                <button class="menu-item" onclick="menuAction('create')">
                    <i class="ri-add-box-line"></i> Create New Playlist
                </button>
                <button class="menu-item red" onclick="menuAction('delete_file')">
                    <i class="ri-delete-bin-line"></i> Delete File
                </button>
            `;
        }
        
        document.getElementById('menuOverlay').style.display = 'flex';
        setTimeout(() => document.getElementById('menuSheet').style.bottom = '0', 10);
    }

    function closeMenu() {
        document.getElementById('menuSheet').style.bottom = '-100%';
        setTimeout(() => document.getElementById('menuOverlay').style.display = 'none', 300);
    }

    function menuAction(action) {
        closeMenu();
        if (!menuTargetFile) return;

        if (action === 'play') {
            const idx = currentQueue.findIndex(f => f.public_id === menuTargetFile.public_id);
            if (idx !== -1) playTrack(idx);
            else {
                // Force play even if not in current queue (plays alone)
                currentQueue = [menuTargetFile];
                playTrack(0);
            }
        } else if (action === 'queue') {
            currentQueue.splice(currentTrackIndex + 1, 0, menuTargetFile);
            alert("Added to queue");
        } else if (action === 'delete_file') {
            if(confirm("Delete this file permanently from the server?")) {
                window.location.href = `/AllBus/${menuTargetFile.public_id.split('/').pop()}`;
            }
        } else if (action === 'create') {
            openCreateModal();
        } else if (action === 'playlist') {
            openAddToPlaylistModal(menuTargetFile.public_id);
        } else if (action === 'remove_from_pl') {
            removeSongFromPlaylist(viewingPlaylistId, menuTargetFile.public_id);
        }
    }

    // --- PLAYLIST LOGIC ---

    function getPlaylistTracks(plId) {
        const pl = savedPlaylists.find(p => p.id === plId);
        if(!pl) return [];
        // Map IDs to actual file objects, filtering out any deleted files
        return pl.fileIds.map(id => allFiles.find(f => f.public_id === id)).filter(Boolean);
    }

    function openCreateModal() {
        playlistActionMode = 'create';
        document.getElementById('createModalTitle').textContent = "New Playlist";
        document.getElementById('newPlaylistName').value = "";
        document.getElementById('createModal').style.display = 'flex';
        document.getElementById('newPlaylistName').focus();
    }
    
    function openRenameModal(plId) {
        playlistActionMode = 'rename';
        const pl = savedPlaylists.find(p => p.id === plId);
        document.getElementById('createModalTitle').textContent = "Rename Playlist";
        document.getElementById('newPlaylistName').value = pl.name;
        document.getElementById('createModal').style.display = 'flex';
        document.getElementById('newPlaylistName').focus();
    }

    function confirmPlaylistAction() {
        const name = document.getElementById('newPlaylistName').value.trim() || "My Playlist";
        
        if (playlistActionMode === 'create') {
            // Create New
            let ids = [];
            if (menuTargetFile) ids = [menuTargetFile.public_id]; // If created from menu
            
            const newPl = { id: Date.now().toString(), name, fileIds: ids };
            savedPlaylists.push(newPl);
            saveToStorage();
            
            if (menuTargetFile) alert("Created & Added!");
            else switchTab('playlists');
            
        } else if (playlistActionMode === 'rename') {
            // Rename Existing
            const pl = savedPlaylists.find(p => p.id === viewingPlaylistId);
            if(pl) {
                pl.name = name;
                saveToStorage();
                renderList(); // Update header
            }
        }
        
        document.getElementById('createModal').style.display = 'none';
        menuTargetFile = null; // Reset
    }

    function openAddToPlaylistModal(fileId) {
        if(savedPlaylists.length === 0) return alert("Create a playlist first");
        const list = document.getElementById('addToPlaylistList');
        list.innerHTML = '';
        savedPlaylists.forEach(pl => {
            const d = document.createElement('div');
            d.className = 'pl-item';
            d.innerHTML = `<span>${pl.name}</span> <span style="font-size:0.8rem; opacity:0.6">${pl.fileIds.length} songs</span>`;
            d.onclick = () => {
                if(!pl.fileIds.includes(fileId)) {
                    pl.fileIds.push(fileId);
                    saveToStorage();
                    alert(`Added to ${pl.name}`);
                } else {
                    alert("Song already in playlist");
                }
                document.getElementById('addModal').style.display = 'none';
            };
            list.appendChild(d);
        });
        document.getElementById('addModal').style.display = 'flex';
    }

    function removeSongFromPlaylist(plId, songId) {
        const pl = savedPlaylists.find(p => p.id === plId);
        if(!pl) return;
        
        // Remove only the first instance of this ID to be safe, or filter all
        // Usually removing via filter is best for unique lists
        pl.fileIds = pl.fileIds.filter(id => id !== songId);
        saveToStorage();
        renderList(); // Re-render the playlist view
    }

    function deletePlaylist(id) {
        if(confirm("Are you sure you want to delete this playlist? This action cannot be undone.")) {
            savedPlaylists = savedPlaylists.filter(p => p.id !== id);
            saveToStorage();
            switchTab('playlists');
        }
    }
    
    function saveToStorage() {
        localStorage.setItem('vibePlaylists', JSON.stringify(savedPlaylists));
    }

    // --- VIEW NAVIGATION ---
    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('tab-songs').className = (tab === 'all') ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-playlists').className = (tab === 'playlists' || tab === 'single_playlist') ? 'tab-btn active' : 'tab-btn';
        
        if (tab === 'all' || tab === 'playlists') {
            menuTargetFile = null; // Clear context
        }
        
        renderList();
    }

    function openPlaylistView(id) {
        viewingPlaylistId = id;
        currentTab = 'single_playlist';
        renderList(); 
    }

    function filterSongs() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        displayedFiles = allFiles.filter(f => f.cleanTitle.toLowerCase().includes(q) || f.cleanArtist.toLowerCase().includes(q));
        renderList();
    }

    // --- PLAYER CONTROLS ---
    function updatePlayBtn() {
        playPauseBtn.innerHTML = isPlaying ? 
            '<i class="ri-pause-fill" style="margin-left:0"></i>' : 
            '<i class="ri-play-fill" style="margin-left:5px"></i>';
    }

    playPauseBtn.onclick = () => {
        if (!audioPlayer.src && currentQueue.length > 0) playTrack(0);
        else if (isPlaying) { audioPlayer.pause(); isPlaying = false; }
        else { audioPlayer.play(); isPlaying = true; }
        updatePlayBtn();
    };

    document.getElementById('nextBtn').onclick = () => {
        let next = isShuffle ? Math.floor(Math.random()*currentQueue.length) : (currentTrackIndex + 1) % currentQueue.length;
        playTrack(next);
    };
    
    document.getElementById('prevBtn').onclick = () => {
        let prev = (currentTrackIndex - 1 + currentQueue.length) % currentQueue.length;
        playTrack(prev);
    };

    document.getElementById('shuffleBtn').onclick = function() {
        isShuffle = !isShuffle;
        this.className = isShuffle ? 'ctrl-btn-small active' : 'ctrl-btn-small';
    };
    document.getElementById('loopBtn').onclick = function() {
        isLoop = !isLoop;
        this.className = isLoop ? 'ctrl-btn-small active' : 'ctrl-btn-small';
    };

    audioPlayer.onended = () => {
        if(isLoop) { audioPlayer.currentTime = 0; audioPlayer.play(); }
        else document.getElementById('nextBtn').click();
    };

    audioPlayer.ontimeupdate = () => {
        if (audioPlayer.duration) {
            const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            seekSlider.value = pct;
            updateSliderFill(pct);
            document.getElementById('currentTimeText').innerText = formatTime(audioPlayer.currentTime);
            document.getElementById('totalTimeText').innerText = formatTime(audioPlayer.duration);
        }
    };
    
    seekSlider.oninput = () => {
        const time = (seekSlider.value / 100) * audioPlayer.duration;
        audioPlayer.currentTime = time;
        updateSliderFill(seekSlider.value);
    };

    function updateSliderFill(val) {
        const blue = getComputedStyle(document.body).getPropertyValue('--accent-blue').trim();
        seekSlider.style.background = `linear-gradient(to right, ${blue} 0%, ${blue} ${val}%, rgba(91,141,239,0.15) ${val}%, rgba(91,141,239,0.15) 100%)`;
    }

    function formatTime(s) {
        if(!s) return "0:00";
        const m = Math.floor(s/60);
        const sec = Math.floor(s%60);
        return m + ":" + (sec < 10 ? "0"+sec : sec);
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('themeIcon').className = isDark ? 'ri-sun-fill' : 'ri-moon-fill';
        localStorage.setItem('vibeTheme', isDark ? 'dark' : 'light');
    }
    if (localStorage.getItem('vibeTheme') === 'dark') toggleTheme();

    renderList();

  </script>
</body>
</html>
