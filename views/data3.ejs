<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Music Player</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet"/>
  <!-- Poppins for the clean look -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- Theming Variables --- */
    :root {
      /* Glassmorphism Variables - Dystopian/Dark Base */
      --glass-bg: rgba(20, 20, 20, 0.6);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.7);
      --backdrop-blur: 25px;
      
      --text-main: #ffffff;
      --text-sub: #888888;
      
      /* Neon Accents for Dystopian Vibe */
      --accent: #00f3ff; /* Neon Cyan */
      --accent-deep: #bc13fe; /* Electric Purple */
      
      --btn-radius: 50%;
    }

    body.dark-mode {
      /* Even Darker/High Contrast Mode */
      --glass-bg: rgba(0, 0, 0, 0.85);
      --glass-border: rgba(255, 255, 255, 0.05);
      --text-main: #f0f0f0;
      --text-sub: #555555;
      
      --accent: #ff0055; /* Cyber Red */
      --accent-deep: #ff0055;
    }

    /* Reset & Base */
    * {
      box-sizing: border-box;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Poppins', sans-serif;
      /* Deep Dystopian Gradient */
      background: linear-gradient(135deg, #050505 0%, #1a1a2e 50%, #16213e 100%);
      background-size: 400% 400%;
      animation: gradientBG 20s ease infinite;
      
      color: var(--text-main);
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: color 0.3s ease;
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* --- Bouncing Spheres Background (Neon/Dark) --- */
    .spheres-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: -1;
        pointer-events: none;
    }

    .sphere {
        position: absolute;
        border-radius: 50%;
        /* Darker, moodier spheres with neon rims */
        background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(0,0,0,0));
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.1); 
        animation: float 20s infinite ease-in-out;
    }

    /* Sphere Configurations */
    .sphere:nth-child(1) { width: 250px; height: 250px; top: -50px; left: -50px; background: radial-gradient(circle, rgba(188, 19, 254, 0.15) 0%, transparent 70%); animation-duration: 25s; border: none; }
    .sphere:nth-child(2) { width: 350px; height: 350px; bottom: -100px; right: -50px; background: radial-gradient(circle, rgba(0, 243, 255, 0.15) 0%, transparent 70%); animation-duration: 30s; border: none; }
    .sphere:nth-child(3) { width: 100px; height: 100px; top: 40%; left: 60%; border-color: rgba(0, 243, 255, 0.3); animation-duration: 18s; }
    .sphere:nth-child(4) { width: 60px; height: 60px; bottom: 20%; left: 10%; border-color: rgba(188, 19, 254, 0.3); animation-duration: 22s; }
    .sphere:nth-child(5) { width: 40px; height: 40px; top: 20%; right: 20%; background: rgba(255, 255, 255, 0.1); animation-duration: 15s; }

    @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-40px) rotate(20deg); }
    }

    /* --- Header --- */
    header {
      padding: 40px 25px 10px;
      /* Dark Glass Header */
      background: var(--glass-bg);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
      border-bottom: 1px solid var(--glass-border);
      z-index: 10;
      flex-shrink: 0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
    }

    .header-left {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .subtitle {
        font-size: 0.8rem;
        letter-spacing: 2px;
        color: var(--accent); /* Neon Cyan */
        font-weight: 700;
        text-transform: uppercase;
        text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
    }

    .title-switcher {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .main-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-main);
        background: transparent;
        border: none;
        padding: 0;
        cursor: pointer;
        transition: opacity 0.2s;
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    .main-title.inactive {
        opacity: 0.4;
        font-size: 1.4rem;
    }

    .header-right {
        display: flex;
        gap: 15px;
    }

    /* Edgy/Tech Buttons */
    .neu-btn {
        width: 45px;
        height: 45px;
        border-radius: 12px; /* Less rounded for dystopian feel */
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-main);
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        backdrop-filter: blur(4px);
        transition: all 0.2s ease;
    }

    .neu-btn:active, .neu-btn.active {
        background: var(--accent);
        color: #000;
        border-color: var(--accent);
        box-shadow: 0 0 15px var(--accent);
    }
    
    .neu-btn.primary {
        background: rgba(0, 243, 255, 0.1);
        color: var(--accent);
        font-weight: bold;
        border-color: var(--accent);
    }

    /* --- Music List Area --- */
    .music-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px 25px 300px; 
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
      scrollbar-width: none;
    }
    .music-container::-webkit-scrollbar { display: none; }

    /* Playlist Controls */
    .playlist-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        margin-top: 10px;
    }
    
    .text-btn {
        background: rgba(255,255,255,0.05);
        border: 1px solid var(--glass-border);
        color: var(--text-main);
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        padding: 6px 14px;
        border-radius: 8px;
    }

    /* Track Item */
    .track {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(5px);
      padding: 15px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: transform 0.2s, background 0.2s, border-color 0.2s;
    }
    
    .track:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--accent);
        transform: translateX(5px);
    }
    
    .track-play-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: rgba(255,255,255,0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-main);
        font-size: 1rem;
        flex-shrink: 0;
        margin-right: 15px;
        transition: all 0.3s;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .track.active-track {
        background: linear-gradient(90deg, rgba(0, 243, 255, 0.15), transparent);
        border-left: 3px solid var(--accent);
        border-color: var(--glass-border);
    }

    .track.active-track .track-play-btn {
        background: var(--accent);
        color: #000;
        box-shadow: 0 0 15px var(--accent);
        border-color: transparent;
    }

    .track-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
    }

    .track-artist {
        font-size: 0.7rem;
        color: var(--text-sub);
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        margin-bottom: 2px;
    }
    
    .track-title {
        font-size: 1rem;
        color: var(--text-main);
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .more-btn {
        background: transparent;
        border: none;
        color: var(--text-sub);
        font-size: 1.4rem;
        cursor: pointer;
        padding: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 10px;
    }
    .more-btn:active { color: var(--accent); }

    /* Select Mode */
    .select-check {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--text-sub);
        margin-right: 20px;
        display: none;
        align-items: center;
        justify-content: center;
        color: #000;
    }
    
    .track.selection-mode .select-check { display: flex; }
    .track.selection-mode .track-play-btn { display: none; }
    
    .track.selected .select-check {
        background: var(--accent);
        border-color: var(--accent);
        box-shadow: 0 0 10px var(--accent);
    }

    .playlist-card {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: border-color 0.2s;
    }
    .playlist-card:hover { border-color: var(--accent); }

    /* --- Floating Player (Cyber-Box) --- */
    .player-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 92%;
        max-width: 500px;
        z-index: 100;
        padding-bottom: env(safe-area-inset-bottom);
    }

    .player {
        background: rgba(10, 10, 10, 0.85);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 20px; /* Slightly sharper corners */
        padding: 20px 25px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .player-info {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .player-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        margin-bottom: 4px;
        text-shadow: 0 0 10px rgba(255,255,255,0.2);
    }
    
    .player-artist {
        font-size: 0.75rem;
        color: var(--accent);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 0 5px var(--accent);
    }

    /* Timeline Section */
    .timeline-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .progress-track {
        width: 100%;
        height: 4px;
        background: rgba(255,255,255,0.1); 
        border-radius: 2px;
        position: relative;
        cursor: pointer;
    }

    input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        height: 100%;
        background: transparent;
        position: absolute;
        top: 0; left: 0;
        margin: 0;
        z-index: 5;
    }

    input[type=range]:focus { outline: none; }

    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 16px; 
        width: 16px; 
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
        margin-top: -6px; 
        box-shadow: 0 0 15px var(--accent);
        border: 2px solid #000;
    }
    
    .time-labels {
        display: flex;
        justify-content: space-between;
        width: 100%;
        font-size: 0.7rem;
        color: var(--text-sub);
        font-weight: 600;
        letter-spacing: 1px;
    }

    /* Controls Section */
    .player-controls {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 10px;
    }

    .main-play-btn {
        width: 65px;
        height: 65px;
        border-radius: 50%;
        background: transparent;
        border: 2px solid var(--accent);
        box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        color: var(--text-main);
        font-size: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .main-play-btn:active { background: var(--accent); color: #000; box-shadow: 0 0 30px var(--accent); }

    .mini-btn {
        background: transparent;
        border: none;
        color: var(--text-sub);
        font-size: 1.4rem;
        cursor: pointer;
        padding: 10px;
        transition: transform 0.2s;
    }
    .mini-btn:hover { color: var(--accent); text-shadow: 0 0 8px var(--accent); transform: scale(1.1); }
    .mini-btn.active { color: var(--accent); text-shadow: 0 0 8px var(--accent); }

    /* Modals & Menus */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        backdrop-filter: blur(10px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
    }
    
    .modal {
        background: rgba(20, 20, 20, 0.95);
        padding: 30px;
        border-radius: 20px;
        width: 85%;
        max-width: 320px;
        text-align: center;
        border: 1px solid var(--accent);
        box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
    }
    
    .modal input {
        width: 100%;
        padding: 15px;
        margin: 20px 0;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(0,0,0,0.5);
        color: var(--text-main);
        font-family: inherit;
    }
    
    .modal-btns { display: flex; gap: 15px; justify-content: center; }

    /* Bottom Sheet Menu */
    .bottom-sheet-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 150;
        display: none;
        opacity: 0;
        transition: opacity 0.3s;
        backdrop-filter: blur(8px);
    }
    
    .bottom-sheet {
        position: fixed;
        bottom: -100%;
        left: 0;
        width: 100%;
        background: rgba(15, 15, 20, 0.95);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 20px 20px 0 0;
        padding: 25px;
        border-top: 1px solid var(--accent);
        box-shadow: 0 -10px 50px rgba(0, 243, 255, 0.15);
        transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 151;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .sheet-title {
        text-align: center;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        font-size: 1.1rem;
        letter-spacing: 1px;
    }
    
    .menu-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: rgba(255,255,255,0.03);
        border: none;
        font-size: 1rem;
        color: var(--text-main);
        cursor: pointer;
        text-align: left;
        border-radius: 8px;
        transition: background 0.2s;
    }
    
    .menu-item:hover { background: rgba(0, 243, 255, 0.1); color: var(--accent); }
    .menu-item i { font-size: 1.3rem; color: var(--text-sub); }
    .menu-item.danger { color: #ff0055; background: rgba(255, 0, 85, 0.1); }
    .menu-item.danger i { color: #ff0055; }

    a { text-decoration: none; }

    /* Playlist Selection List in Modal */
    .playlist-select-list {
        max-height: 200px;
        overflow-y: auto;
        margin: 15px 0;
        text-align: left;
    }
    .playlist-option {
        padding: 12px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        cursor: pointer;
        color: var(--text-main);
    }
    .playlist-option:hover { color: var(--accent); background: rgba(255,255,255,0.1); }

    /* --- Desktop View --- */
    @media (min-width: 768px) {
      .player-container { width: 550px; left: auto; right: 40px; bottom: 40px; transform: none; }
      .header, .music-container { max-width: 800px; }
      
      .player { flex-direction: row; flex-wrap: wrap; text-align: left; }
      .player-info { width: 35%; align-items: flex-start; text-align: left; }
      .timeline-container { width: 100%; order: 3; margin-top: 10px; }
      .player-controls { width: 60%; justify-content: flex-end; gap: 15px; }
    }
  </style>
</head>
<body>

  <!-- Animated Spheres Background -->
  <div class="spheres-container">
      <div class="sphere"></div>
      <div class="sphere"></div>
      <div class="sphere"></div>
      <div class="sphere"></div>
      <div class="sphere"></div>
  </div>

  <!-- Header -->
  <header>
    <div class="header">
        <div class="header-left">
            <div class="subtitle">LIBRARY</div>
            <div class="title-switcher">
                <button class="main-title" onclick="switchTab('all')" id="tab-all">Songs</button>
                <button class="main-title inactive" onclick="switchTab('playlists')" id="tab-playlists">Playlists</button>
            </div>
        </div>

        <div class="header-right">
            <button class="neu-btn" onclick="toggleTheme()" title="Toggle Theme"><i class="ri-moon-line" id="themeIcon"></i></button>
            <button class="neu-btn" onclick="toggleSelectionMode(true)" id="selectBtn" title="Select Songs"><i class="ri-list-check"></i></button>
            <a href="/postmp3"><button class="neu-btn primary" title="Upload New"><i class="ri-add-line"></i></button></a>
        </div>
    </div>
  </header>
  
  <!-- Main List -->
  <div class="music-container" id="mainContainer">
    <!-- Tracks injected via JS -->
  </div>

  <!-- Player Card -->
  <div class="player-container">
      <div class="player">
        
        <div class="player-info">
            <div class="player-title" id="currentTrack">Select a track</div>
            <div class="player-artist" id="currentArtist">NOW PLAYING</div>
        </div>
        
        <div class="timeline-container">
            <div class="progress-track" id="sliderTrack">
                <input type="range" id="seekSlider" value="0" min="0" max="100" step="0.1">
            </div>
            <div class="time-labels">
                <span id="currentTimeText">0:00</span>
                <span id="totalTimeText">0:00</span>
            </div>
        </div>

        <div class="player-controls">
            <button class="mini-btn" id="shuffleBtn"><i class="ri-shuffle-line"></i></button>
            <button class="mini-btn" id="prevBtn"><i class="ri-skip-back-fill"></i></button>
            
            <button class="main-play-btn" id="playPauseBtn">
                <i class="ri-play-fill"></i>
            </button>
            
            <button class="mini-btn" id="nextBtn"><i class="ri-skip-forward-fill"></i></button>
            <button class="mini-btn" id="loopBtn"><i class="ri-repeat-line"></i></button>
        </div>

      </div>
  </div>

  <audio id="audioPlayer"></audio>

  <!-- Create Playlist Modal -->
  <div class="modal-overlay" id="playlistModal">
      <div class="modal">
          <h3 style="color: var(--text-main); margin-top:0;">New Playlist</h3>
          <input type="text" id="playlistNameInput" placeholder="Playlist Name">
          <div class="modal-btns">
              <button class="neu-btn" onclick="closeModal()"><i class="ri-close-line"></i></button>
              <button class="neu-btn primary" onclick="confirmSavePlaylist()"><i class="ri-check-line"></i></button>
          </div>
      </div>
  </div>

  <!-- Add to Existing Playlist Modal -->
  <div class="modal-overlay" id="addToPlaylistModal">
      <div class="modal">
          <h3 style="color: var(--text-main); margin-top:0;">Add to Playlist</h3>
          <div class="playlist-select-list" id="playlistSelectList">
              <!-- JS Populated -->
          </div>
          <div class="modal-btns">
              <button class="neu-btn" onclick="document.getElementById('addToPlaylistModal').style.display='none'"><i class="ri-close-line"></i></button>
          </div>
      </div>
  </div>

  <!-- Track Menu Bottom Sheet -->
  <div class="bottom-sheet-overlay" id="trackMenuOverlay" onclick="closeTrackMenu()">
      <div class="bottom-sheet" id="trackMenu" onclick="event.stopPropagation()">
          <div class="sheet-title" id="menuTitle">Track Options</div>
          <button class="menu-item" onclick="menuAction('play')"><i class="ri-play-fill"></i> Play Now</button>
          <button class="menu-item" onclick="menuAction('queue')"><i class="ri-play-list-add-line"></i> Play Next (Queue)</button>
          <button class="menu-item" onclick="menuAction('playlist')"><i class="ri-folder-add-line"></i> Add to Playlist</button>
          <button class="menu-item" onclick="menuAction('create_playlist')"><i class="ri-add-box-line"></i> Create New Playlist</button>
          <button class="menu-item danger" onclick="menuAction('delete')"><i class="ri-delete-bin-line"></i> Delete File</button>
      </div>
  </div>

  <script>
    // --- Data Initialization ---
    const rawFiles = <%- JSON.stringify(files) %>;
    
    // Sort logic
    const allFiles = rawFiles.map(file => {
        const rawName = file.originalname.replace(/\.[^.]+$/, '');
        const parts = rawName.split(/[_-]/);
        let artist = parts.length > 1 ? parts[0].trim() : "Unknown";
        let title = parts.length > 1 ? parts.slice(1).join(' ').trim() : parts[0];
        return { ...file, cleanTitle: title, cleanArtist: artist };
    }).sort((a, b) => a.cleanTitle.localeCompare(b.cleanTitle));
    
    // State
    let currentQueue = [...allFiles]; 
    let currentTrackIndex = 0;
    let isPlaying = false;
    let isShuffleEnabled = false;
    let isLoopEnabled = false;
    let isSelectionMode = false;
    let selectedIndices = new Set();
    let currentTab = 'all'; 
    let viewingPlaylistId = null;
    let selectedTrackForMenu = null; // Stores {index, context, fileId}

    let savedPlaylists = JSON.parse(localStorage.getItem('vibePlaylists')) || [];

    // DOM Elements
    const audioPlayer = document.getElementById("audioPlayer");
    const currentTrackEl = document.getElementById("currentTrack");
    const currentArtistEl = document.getElementById("currentArtist");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const loopBtn = document.getElementById("loopBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const mainContainer = document.getElementById("mainContainer");
    const themeIcon = document.getElementById("themeIcon");
    const seekSlider = document.getElementById("seekSlider");
    const sliderTrack = document.getElementById("sliderTrack");
    const currentTimeText = document.getElementById("currentTimeText");
    const totalTimeText = document.getElementById("totalTimeText");

    // --- RENDER LOGIC ---
    function renderAllSongs() {
        let html = '';
        if(isSelectionMode) {
            html += `
            <div class="playlist-controls">
                <span style="font-weight:600; color:var(--text-sub)">${selectedIndices.size} selected</span>
                <div style="display:flex; gap:15px;">
                     <button class="text-btn" onclick="toggleSelectionMode(false)">Cancel</button>
                     <button class="text-btn" onclick="openSaveModal()">Save</button>
                </div>
            </div>`;
        } else {
            html += `<div style="height:10px;"></div>`;
        }

        if (allFiles.length === 0) {
            html += `<div style="text-align:center; margin-top:50px; color:var(--text-sub);"><p>No songs found</p></div>`;
        } else {
            allFiles.forEach((file, index) => {
                
                const isSelected = selectedIndices.has(index) ? 'selected' : '';
                const selectClass = isSelectionMode ? 'selection-mode' : '';
                
                const fileId = file.public_id;
                const playingId = currentQueue[currentTrackIndex]?.public_id;
                const isCurrent = (fileId === playingId && currentTab === 'all');
                
                const activeClass = isCurrent ? 'active-track' : '';
                const icon = (isCurrent && isPlaying) ? '<i class="ri-pause-fill"></i>' : '<i class="ri-play-fill"></i>';

                html += `
                <div class="track ${selectClass} ${isSelected} ${activeClass}" onclick="handleTrackClick(${index}, 'all')">
                  <div class="select-check"><i class="ri-check-line"></i></div>
                  <div class="track-play-btn">${icon}</div>
                  <div class="track-info">
                    <div class="track-artist">${file.cleanArtist}</div>
                    <div class="track-title">${file.cleanTitle}</div>
                  </div>
                  <!-- Replaced Duration with 3 Dots Menu Button -->
                  <button class="more-btn" onclick="openTrackMenu(event, ${index}, 'all')">
                    <i class="ri-more-2-fill"></i>
                  </button>
                </div>`;
            });
        }
        mainContainer.innerHTML = html;
    }

    function renderPlaylistsTab() {
        let html = `<div class="playlist-controls"><span style="font-weight:700; color:var(--text-main); font-size:1.2rem;">My Playlists</span></div>`;
        if(savedPlaylists.length === 0) {
            html += `<div style="text-align:center; margin-top:50px; color:var(--text-sub);"><p>No playlists yet</p><button class="neu-btn primary" style="width:auto; padding:0 20px; margin:20px auto;" onclick="switchTab('all'); toggleSelectionMode(true);">Create Playlist</button></div>`;
        } else {
            savedPlaylists.forEach(pl => {
                html += `
                <div class="playlist-card" onclick="openPlaylist('${pl.id}')">
                    <div>
                        <h3 style="margin:0; font-size:1.1rem; color:var(--text-main);">${pl.name}</h3>
                        <p style="margin:5px 0 0; font-size:0.8rem; color:var(--text-sub); font-weight:600; text-transform:uppercase;">${pl.fileIds.length} TRACKS</p>
                    </div>
                    <div class="neu-btn" style="width:40px; height:40px; font-size:1rem;"><i class="ri-arrow-right-s-line"></i></div>
                </div>`;
            });
        }
        mainContainer.innerHTML = html;
    }

    function renderSinglePlaylist(id) {
        const playlist = savedPlaylists.find(p => p.id === id);
        if(!playlist) return switchTab('playlists');

        let html = `
            <div class="playlist-controls">
                <button class="neu-btn" onclick="switchTab('playlists')" style="width:40px; height:40px;"><i class="ri-arrow-left-line"></i></button>
                <button class="text-btn" onclick="deletePlaylist('${id}')" style="color:#ff0055;">Delete</button>
            </div>
            <h2 style="margin:0 0 30px; font-size:2rem; color:var(--text-main);">${playlist.name}</h2>
        `;

        const playlistTracks = playlist.fileIds.map(fileId => allFiles.find(f => f.public_id === fileId)).filter(Boolean);

        if (playlistTracks.length === 0) {
            html += `<p style="text-align:center; color:var(--text-sub);">No songs in this playlist.</p>`;
        } else {
            playlistTracks.forEach((file, i) => {
                const isCurrent = (currentQueue[currentTrackIndex]?.public_id === file.public_id && currentTab === 'single_playlist' && viewingPlaylistId === id);
                const activeClass = isCurrent ? 'active-track' : '';
                const icon = (isCurrent && isPlaying) ? '<i class="ri-pause-fill"></i>' : '<i class="ri-play-fill"></i>';

                html += `
                <div class="track ${activeClass}" onclick="handleTrackClick(${i}, 'playlist')">
                  <div class="track-play-btn">${icon}</div>
                  <div class="track-info">
                    <div class="track-artist">${file.cleanArtist}</div>
                    <div class="track-title">${file.cleanTitle}</div>
                  </div>
                  <!-- Menu Button for Playlist Tracks too -->
                  <button class="more-btn" onclick="openTrackMenu(event, ${i}, 'playlist')">
                    <i class="ri-more-2-fill"></i>
                  </button>
                </div>`;
            });
        }
        mainContainer.innerHTML = html;
    }

    // --- MENU SYSTEM ---
    function openTrackMenu(e, index, context) {
        e.stopPropagation();
        
        let file;
        if(context === 'all') file = allFiles[index];
        else if(context === 'playlist') {
             const playlist = savedPlaylists.find(p => p.id === viewingPlaylistId);
             const trackId = playlist.fileIds[index];
             file = allFiles.find(f => f.public_id === trackId);
        }

        if(!file) return;

        selectedTrackForMenu = { index, context, file };
        document.getElementById('menuTitle').textContent = file.cleanTitle;
        
        const overlay = document.getElementById('trackMenuOverlay');
        const sheet = document.getElementById('trackMenu');
        
        overlay.style.display = 'block';
        setTimeout(() => {
            overlay.style.opacity = '1';
            sheet.style.bottom = '0';
        }, 10);
    }

    function closeTrackMenu() {
        const overlay = document.getElementById('trackMenuOverlay');
        const sheet = document.getElementById('trackMenu');
        
        sheet.style.bottom = '-100%';
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 300);
    }

    function menuAction(action) {
        if(!selectedTrackForMenu) return;
        const { index, context, file } = selectedTrackForMenu;
        closeTrackMenu();

        switch(action) {
            case 'play':
                // Reset queue to appropriate context and play
                if(context === 'all') {
                    currentQueue = [...allFiles];
                    playTrack(index);
                } else if (context === 'playlist') {
                    // Logic already handled in handleTrackClick mostly, reuse logic
                    handleTrackClick(index, 'playlist');
                }
                break;
                
            case 'queue':
                // Insert into current queue right after current playing index
                // This is a simple implementation. 
                // A full queue system would need a separate 'nextUp' array.
                // Here we mutate currentQueue for simplicity.
                currentQueue.splice(currentTrackIndex + 1, 0, file);
                alert("Added to queue for next play");
                break;
                
            case 'delete':
                if(confirm(`Delete ${file.cleanTitle} permanently?`)) {
                    window.location.href = `/AllBus/${file.public_id.split('/').pop()}`;
                }
                break;
            
            case 'create_playlist':
                // Pre-select this track and open create modal
                selectedIndices.clear();
                // Find index in allFiles to set selected
                const masterIndex = allFiles.findIndex(f => f.public_id === file.public_id);
                if(masterIndex > -1) selectedIndices.add(masterIndex);
                openSaveModal();
                break;
                
            case 'playlist':
                openAddToPlaylistModal(file.public_id);
                break;
        }
    }

    function openAddToPlaylistModal(fileId) {
        const modal = document.getElementById('addToPlaylistModal');
        const list = document.getElementById('playlistSelectList');
        list.innerHTML = '';
        
        if(savedPlaylists.length === 0) {
            list.innerHTML = '<p style="padding:10px; color:var(--text-sub)">No playlists found. Create one first.</p>';
        } else {
            savedPlaylists.forEach(pl => {
                const div = document.createElement('div');
                div.className = 'playlist-option';
                div.textContent = pl.name;
                div.onclick = () => {
                    pl.fileIds.push(fileId);
                    localStorage.setItem('vibePlaylists', JSON.stringify(savedPlaylists));
                    alert(`Added to ${pl.name}`);
                    modal.style.display = 'none';
                };
                list.appendChild(div);
            });
        }
        modal.style.display = 'flex';
    }

    // --- LOGIC ---
    function formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return "0:00";
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function switchTab(tab) {
        currentTab = tab;
        isSelectionMode = false;
        selectedIndices.clear();
        document.getElementById('tab-all').classList.toggle('inactive', tab !== 'all');
        document.getElementById('tab-playlists').classList.toggle('inactive', tab !== 'playlists');
        if(tab === 'all') renderAllSongs();
        else if(tab === 'playlists') renderPlaylistsTab();
    }

    function handleTrackClick(index, context) {
        // If clicking on track body (not menu), play it
        if (isSelectionMode && context === 'all') {
            if(selectedIndices.has(index)) selectedIndices.delete(index);
            else selectedIndices.add(index);
            renderAllSongs();
            return;
        }
        if (context === 'all') {
            currentQueue = [...allFiles];
            playTrack(index);
        } else if (context === 'playlist') {
            const playlist = savedPlaylists.find(p => p.id === viewingPlaylistId);
            if(playlist) {
                const playlistTracks = playlist.fileIds.map(id => allFiles.find(f => f.public_id === id)).filter(Boolean);
                currentQueue = playlistTracks;
                playTrack(index); 
            }
        }
    }

    function toggleSelectionMode(active) {
        isSelectionMode = active;
        selectedIndices.clear();
        renderAllSongs();
    }

    function openSaveModal() {
        if(selectedIndices.size === 0) return alert("Select songs first");
        document.getElementById('playlistModal').style.display = 'flex';
        document.getElementById('playlistNameInput').focus();
    }
    function closeModal() { document.getElementById('playlistModal').style.display = 'none'; }

    function confirmSavePlaylist() {
        const name = document.getElementById('playlistNameInput').value.trim() || "My Playlist";
        const selectedIds = Array.from(selectedIndices).map(idx => allFiles[idx].public_id);
        const newPlaylist = { id: Date.now().toString(), name: name, fileIds: selectedIds };
        savedPlaylists.push(newPlaylist);
        localStorage.setItem('vibePlaylists', JSON.stringify(savedPlaylists));
        closeModal();
        switchTab('playlists');
    }

    function openPlaylist(id) {
        viewingPlaylistId = id;
        currentTab = 'single_playlist';
        renderSinglePlaylist(id);
    }
    
    function deletePlaylist(id) {
        if(confirm("Delete playlist?")) {
            savedPlaylists = savedPlaylists.filter(p => p.id !== id);
            localStorage.setItem('vibePlaylists', JSON.stringify(savedPlaylists));
            switchTab('playlists');
        }
    }

    function playTrack(index) {
        if(index < 0 || index >= currentQueue.length) return;
        currentTrackIndex = index;
        const song = currentQueue[index];
        if(audioPlayer.src !== song.url) audioPlayer.src = song.url;
        currentTrackEl.textContent = song.cleanTitle;
        currentArtistEl.textContent = song.cleanArtist;
        audioPlayer.play().catch(e => console.log("User interaction needed"));
        isPlaying = true;
        updatePlayBtnUI();
        if(currentTab === 'all') renderAllSongs();
        if(currentTab === 'single_playlist') renderSinglePlaylist(viewingPlaylistId);
    }

    function updatePlayBtnUI() {
        playPauseBtn.innerHTML = isPlaying ? '<i class="ri-pause-fill"></i>' : '<i class="ri-play-fill"></i>';
    }

    function togglePlayPause() {
        if (!audioPlayer.src && currentQueue.length > 0) { playTrack(0); return; }
        if (isPlaying) audioPlayer.pause(); else audioPlayer.play();
        isPlaying = !isPlaying;
        updatePlayBtnUI();
        if(currentTab === 'all') renderAllSongs();
        if(currentTab === 'single_playlist') renderSinglePlaylist(viewingPlaylistId);
    }

    function nextTrack() {
        if(isLoopEnabled) { audioPlayer.currentTime = 0; audioPlayer.play(); return; }
        if (isShuffleEnabled) currentTrackIndex = Math.floor(Math.random() * currentQueue.length);
        else currentTrackIndex = (currentTrackIndex + 1) % currentQueue.length;
        playTrack(currentTrackIndex);
    }

    function prevTrack() {
        if (audioPlayer.currentTime > 3) { audioPlayer.currentTime = 0; return; }
        currentTrackIndex = (currentTrackIndex - 1 + currentQueue.length) % currentQueue.length;
        playTrack(currentTrackIndex);
    }

    loopBtn.onclick = () => { isLoopEnabled = !isLoopEnabled; loopBtn.classList.toggle('active', isLoopEnabled); };
    shuffleBtn.onclick = () => { isShuffleEnabled = !isShuffleEnabled; shuffleBtn.classList.toggle('active', isShuffleEnabled); };
    playPauseBtn.onclick = togglePlayPause;
    document.getElementById("nextBtn").onclick = nextTrack;
    document.getElementById("prevBtn").onclick = prevTrack;
    audioPlayer.onended = nextTrack;
    
    // --- TIMELINE LOGIC ---
    audioPlayer.onloadedmetadata = () => { totalTimeText.textContent = formatTime(audioPlayer.duration); };
    audioPlayer.ontimeupdate = () => {
        if(audioPlayer.duration) {
            const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            seekSlider.value = percent;
            updateSliderStyle(percent);
            currentTimeText.textContent = formatTime(audioPlayer.currentTime);
        }
    };
    seekSlider.oninput = () => {
        const seekTime = (seekSlider.value / 100) * audioPlayer.duration;
        audioPlayer.currentTime = seekTime;
        updateSliderStyle(seekSlider.value);
        currentTimeText.textContent = formatTime(seekTime);
    };
    function updateSliderStyle(value) {
        const accent = getComputedStyle(document.body).getPropertyValue('--accent').trim();
        const bg = `linear-gradient(to right, ${accent} 0%, ${accent} ${value}%, rgba(255,255,255,0.1) ${value}%, rgba(255,255,255,0.1) 100%)`;
        sliderTrack.style.background = bg;
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        themeIcon.className = isDark ? 'ri-sun-line' : 'ri-moon-line';
        localStorage.setItem('vibeTheme', isDark ? 'dark' : 'light');
    }
    if(localStorage.getItem('vibeTheme') === 'dark') toggleTheme();

    renderAllSongs();
  </script>
</body>
</html>
