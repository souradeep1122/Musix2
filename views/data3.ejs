<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Player</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet"/>
  <!-- Poppins for the clean look -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- Theming Variables (Matches Reference: Soft White & Pink) --- */
    :root {
      /* Light Mode */
      --bg-main: #EBECF0; /* Soft greyish white for neumorphism base */
      --text-main: #4a4a4a;
      --text-sub: #a0a0a0;
      
      --accent: #FF9EB5; /* Soft Pink from reference */
      --accent-deep: #FF7696;
      
      /* Neumorphic Shadows */
      --shadow-light: -6px -6px 14px rgba(255, 255, 255, 1);
      --shadow-dark: 6px 6px 10px rgba(174, 174, 192, 0.4);
      --shadow-inset: inset 4px 4px 8px rgba(174, 174, 192, 0.4), inset -4px -4px 8px rgba(255, 255, 255, 1);
      
      --btn-radius: 50%;
      --card-radius: 30px;
    }

    body.dark-mode {
      /* Dark Mode Variant */
      --bg-main: #292d32;
      --text-main: #e0e0e0;
      --text-sub: #8b8b8b;
      
      --accent: #FF9EB5;
      --accent-deep: #ff5c8d;
      
      --shadow-light: -4px -4px 10px rgba(60, 60, 60, 0.5);
      --shadow-dark: 4px 4px 10px rgba(0, 0, 0, 0.3);
      --shadow-inset: inset 3px 3px 6px rgba(0, 0, 0, 0.4), inset -3px -3px 6px rgba(60, 60, 60, 0.3);
    }

    /* Reset & Base */
    * {
      box-sizing: border-box;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* --- Header --- */
    header {
      padding: 40px 30px 10px;
      background: var(--bg-main);
      z-index: 10;
      flex-shrink: 0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
    }

    .header-left {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .subtitle {
        font-size: 0.8rem;
        letter-spacing: 1.5px;
        color: var(--text-sub);
        font-weight: 600;
        text-transform: uppercase;
    }

    .title-switcher {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .main-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-main);
        background: transparent;
        border: none;
        padding: 0;
        cursor: pointer;
        transition: opacity 0.2s;
    }
    
    .main-title.inactive {
        opacity: 0.3;
        font-size: 1.4rem;
    }

    .header-right {
        display: flex;
        gap: 15px;
    }

    /* Neumorphic Button Class */
    .neu-btn {
        width: 45px;
        height: 45px;
        border-radius: var(--btn-radius);
        background: var(--bg-main);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-sub);
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: var(--shadow-dark), var(--shadow-light);
        transition: all 0.2s ease;
    }

    .neu-btn:active, .neu-btn.active {
        box-shadow: var(--shadow-inset);
        color: var(--accent-deep);
    }
    
    .neu-btn.primary {
        color: var(--accent-deep);
    }

    /* --- Music List Area --- */
    .music-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px 30px 180px; /* Extra bottom padding for stacked player */
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
      scrollbar-width: none;
    }
    .music-container::-webkit-scrollbar { display: none; }

    /* Playlist Controls (Save/Cancel) */
    .playlist-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        margin-top: 10px;
    }
    
    .text-btn {
        background: transparent;
        border: none;
        color: var(--accent-deep);
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        padding: 5px 10px;
    }

    /* Track Item */
    .track {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      cursor: pointer;
      background: transparent;
      transition: transform 0.2s;
    }
    
    .track-play-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--bg-main);
        box-shadow: var(--shadow-dark), var(--shadow-light);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-main);
        font-size: 1rem;
        flex-shrink: 0;
        margin-right: 20px;
        transition: all 0.3s;
    }

    .track:hover .track-play-btn {
        color: var(--accent-deep);
        transform: scale(1.05);
    }

    .track.active-track .track-play-btn {
        box-shadow: var(--shadow-inset);
        color: var(--accent-deep);
        border: 1px solid rgba(255, 118, 147, 0.1);
    }

    .track-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
    }

    .track-artist {
        font-size: 0.7rem;
        color: var(--text-sub);
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        margin-bottom: 2px;
    }
    
    .track-title {
        font-size: 1rem;
        color: var(--text-main);
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .track-duration {
        font-size: 0.85rem;
        color: var(--text-sub);
        font-weight: 500;
        margin-left: 15px;
    }

    .select-check {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: var(--bg-main);
        box-shadow: var(--shadow-inset);
        margin-right: 20px;
        display: none;
        align-items: center;
        justify-content: center;
        color: var(--accent-deep);
    }
    
    .track.selection-mode .select-check { display: flex; }
    .track.selection-mode .track-play-btn { display: none; }
    
    .track.selected .select-check {
        background: var(--accent-deep);
        box-shadow: none;
        color: white;
    }

    .playlist-card {
        background: var(--bg-main);
        padding: 20px;
        border-radius: 20px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-dark), var(--shadow-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }
    
    .playlist-card:active { box-shadow: var(--shadow-inset); }

    /* --- Floating Player (Bottom) --- */
    .player-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 550px;
        z-index: 100;
    }

    .player {
        background: var(--bg-main);
        border-radius: 30px;
        padding: 15px 25px 25px 25px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1), var(--shadow-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        overflow: hidden;
    }
    
    .player-info {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
        margin-right: 15px;
        z-index: 2;
    }
    
    .player-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .player-artist {
        font-size: 0.7rem;
        color: var(--accent-deep);
        font-weight: 600;
        text-transform: uppercase;
    }

    .player-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        z-index: 2;
    }

    .main-play-btn {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background: var(--bg-main);
        border: none;
        box-shadow: var(--shadow-dark), var(--shadow-light);
        color: var(--text-main);
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .main-play-btn:active { box-shadow: var(--shadow-inset); }

    .mini-btn {
        background: transparent;
        border: none;
        color: var(--text-sub);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px;
    }
    .mini-btn:hover { color: var(--accent-deep); }
    .mini-btn.active { color: var(--accent-deep); }

    /* Draggable Timeline - Improved Visibility */
    .progress-container {
        position: absolute;
        bottom: 0;
        left: 25px; /* Added left padding */
        width: calc(100% - 50px); /* Adjust width based on padding */
        height: 8px; /* Increased height slightly */
        background: rgba(0,0,0,0.08); /* Darker track for better contrast */
    }

    input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        height: 100%;
        background: transparent;
        cursor: pointer;
        margin: 0;
        border: none;
        position: absolute;
        bottom: 0;
        z-index: 5;
    }

    input[type=range]:focus { outline: none; }

    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 18px; /* Bigger thumb */
        width: 18px; /* Bigger thumb */
        border-radius: 50%;
        background: var(--accent-deep);
        cursor: pointer;
        margin-top: -5px; /* Center thumb vertically relative to track if needed, though for bottom align it's different */
        box-shadow: 0 0 10px rgba(0,0,0,0.3); /* Stronger shadow */
        transition: transform 0.1s;
        border: 2px solid white; /* Add border for definition */
    }
    
    input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
    
    input[type=range]::-moz-range-thumb {
        height: 18px; 
        width: 18px; 
        border-radius: 50%; 
        background: var(--accent-deep); 
        border: 2px solid white;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(235, 236, 240, 0.8);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
    }
    
    .modal {
        background: var(--bg-main);
        padding: 30px;
        border-radius: 30px;
        width: 85%;
        max-width: 320px;
        text-align: center;
        box-shadow: var(--shadow-dark), var(--shadow-light);
    }
    
    .modal input {
        width: 100%;
        padding: 15px;
        margin: 20px 0;
        border-radius: 15px;
        border: none;
        background: var(--bg-main);
        box-shadow: var(--shadow-inset);
        color: var(--text-main);
        font-family: inherit;
    }
    
    .modal-btns { display: flex; gap: 15px; justify-content: center; }

    a { text-decoration: none; }

    /* --- Mobile Responsiveness --- */
    @media (min-width: 768px) {
      .player-container { width: 450px; left: auto; right: 40px; bottom: 40px; transform: none; }
      .header, .music-container { max-width: 800px; }
    }

    @media (max-width: 480px) {
        header { padding: 30px 20px 15px; }
        .main-title { font-size: 1.5rem; }
        .neu-btn { width: 40px; height: 40px; font-size: 1.1rem; }
        
        /* Mobile Player: Stacked Layout to Prevent Overlap */
        .player { 
            flex-direction: column;
            text-align: center;
            padding: 20px 15px 35px 15px; /* Bottom padding for timeline */
            height: auto;
            gap: 15px;
        }
        
        .player-info {
            width: 100%;
            margin-right: 0;
            margin-bottom: 5px;
        }

        .player-controls {
            width: 100%;
            justify-content: space-between;
            padding: 0 10px;
        }
        
        .progress-container {
            /* Ensure it stays at bottom */
            bottom: 0;
        }
        
        .track { margin-bottom: 20px; }
        .player-container { bottom: 15px; width: 95%; }
        .music-container { padding-bottom: 220px; } /* Ensure list clears stacked player */
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="header">
        <div class="header-left">
            <div class="subtitle">LIBRARY</div>
            <div class="title-switcher">
                <button class="main-title" onclick="switchTab('all')" id="tab-all">Songs</button>
                <button class="main-title inactive" onclick="switchTab('playlists')" id="tab-playlists">Playlists</button>
            </div>
        </div>

        <div class="header-right">
            <!-- Theme Toggle -->
            <button class="neu-btn" onclick="toggleTheme()" title="Toggle Theme">
                <i class="ri-moon-line" id="themeIcon"></i>
            </button>
            
            <!-- Select Mode -->
            <button class="neu-btn" onclick="toggleSelectionMode(true)" id="selectBtn" title="Select Songs">
                <i class="ri-list-check"></i>
            </button>
            
            <!-- Upload -->
            <a href="/postmp3">
                <button class="neu-btn primary" title="Upload New">
                    <i class="ri-add-line"></i>
                </button>
            </a>
        </div>
    </div>
  </header>
  
  <!-- Main List -->
  <div class="music-container" id="mainContainer">
    <!-- Tracks injected via JS -->
  </div>

  <!-- Floating Neumorphic Player -->
  <div class="player-container">
      <div class="player">
        <div class="player-info">
            <div class="player-artist" id="currentArtist">NOW PLAYING</div>
            <div class="player-title" id="currentTrack">Select a track</div>
        </div>
        
        <div class="player-controls">
            <button class="mini-btn" id="shuffleBtn" title="Shuffle"><i class="ri-shuffle-line"></i></button>
            <button class="mini-btn" id="prevBtn"><i class="ri-skip-back-fill"></i></button>
            
            <button class="main-play-btn" id="playPauseBtn">
                <i class="ri-play-fill"></i>
            </button>
            
            <button class="mini-btn" id="nextBtn"><i class="ri-skip-forward-fill"></i></button>
            <button class="mini-btn" id="loopBtn" title="Loop"><i class="ri-repeat-line"></i></button>
        </div>
        
        <!-- Draggable Timeline -->
        <div class="progress-container">
            <input type="range" id="seekSlider" value="0" min="0" max="100" step="0.1">
        </div>
      </div>
  </div>

  <audio id="audioPlayer"></audio>

  <!-- Create Playlist Modal -->
  <div class="modal-overlay" id="playlistModal">
      <div class="modal">
          <h3 style="color: var(--text-main); margin-top:0;">New Playlist</h3>
          <input type="text" id="playlistNameInput" placeholder="Playlist Name">
          <div class="modal-btns">
              <button class="neu-btn" onclick="closeModal()"><i class="ri-close-line"></i></button>
              <button class="neu-btn primary" onclick="confirmSavePlaylist()"><i class="ri-check-line"></i></button>
          </div>
      </div>
  </div>

  <script>
    // --- Data Initialization ---
    const rawFiles = <%- JSON.stringify(files) %>;
    
    // Sort logic: Parse title then sort alphabetically
    const allFiles = rawFiles.map(file => {
        const rawName = file.originalname.replace(/\.[^.]+$/, '');
        const parts = rawName.split(/[_-]/);
        let artist = parts.length > 1 ? parts[0].trim() : "Unknown";
        let title = parts.length > 1 ? parts.slice(1).join(' ').trim() : parts[0];
        
        return {
            ...file,
            cleanTitle: title,
            cleanArtist: artist
        };
    }).sort((a, b) => a.cleanTitle.localeCompare(b.cleanTitle));
    
    // State
    let currentQueue = [...allFiles]; 
    let currentTrackIndex = 0;
    let isPlaying = false;
    let isShuffleEnabled = false;
    let isLoopEnabled = false;
    let isSelectionMode = false;
    let selectedIndices = new Set();
    let currentTab = 'all'; 
    let viewingPlaylistId = null;

    let savedPlaylists = JSON.parse(localStorage.getItem('vibePlaylists')) || [];

    // DOM Elements
    const audioPlayer = document.getElementById("audioPlayer");
    const currentTrackEl = document.getElementById("currentTrack");
    const currentArtistEl = document.getElementById("currentArtist");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const loopBtn = document.getElementById("loopBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const mainContainer = document.getElementById("mainContainer");
    const themeIcon = document.getElementById("themeIcon");
    const seekSlider = document.getElementById("seekSlider");

    // --- RENDER LOGIC ---

    function renderAllSongs() {
        let html = '';
        
        if(isSelectionMode) {
            html += `
            <div class="playlist-controls">
                <span style="font-weight:600; color:var(--text-sub)">${selectedIndices.size} selected</span>
                <div style="display:flex; gap:15px;">
                     <button class="text-btn" onclick="toggleSelectionMode(false)">Cancel</button>
                     <button class="text-btn" onclick="openSaveModal()">Save</button>
                </div>
            </div>`;
        } else {
            html += `<div style="height:10px;"></div>`;
        }

        if (allFiles.length === 0) {
            html += `<div style="text-align:center; margin-top:50px; color:var(--text-sub);">
                <i class="ri-music-2-line" style="font-size:3rem; opacity:0.3;"></i>
                <p>No songs found</p>
            </div>`;
        } else {
            allFiles.forEach((file, index) => {
                let durationText = '--:--';
                if(file.duration) {
                     const m = Math.floor(file.duration / 60);
                     const s = String(Math.floor(file.duration % 60)).padStart(2, '0');
                     durationText = `${m}:${s}`;
                }
                
                const isSelected = selectedIndices.has(index) ? 'selected' : '';
                const selectClass = isSelectionMode ? 'selection-mode' : '';
                
                const fileId = file.public_id;
                const playingId = currentQueue[currentTrackIndex]?.public_id;
                const isCurrent = (fileId === playingId && currentTab === 'all');
                
                const activeClass = isCurrent ? 'active-track' : '';
                const icon = (isCurrent && isPlaying) ? '<i class="ri-pause-fill"></i>' : '<i class="ri-play-fill"></i>';

                html += `
                <div class="track ${selectClass} ${isSelected} ${activeClass}" onclick="handleTrackClick(${index}, 'all')">
                  <div class="select-check"><i class="ri-check-line"></i></div>
                  <div class="track-play-btn">${icon}</div>
                  <div class="track-info">
                    <div class="track-artist">${file.cleanArtist}</div>
                    <div class="track-title">${file.cleanTitle}</div>
                  </div>
                  <div class="track-duration">${durationText}</div>
                </div>`;
            });
        }
        mainContainer.innerHTML = html;
    }

    function renderPlaylistsTab() {
        let html = `<div class="playlist-controls"><span style="font-weight:700; color:var(--text-main); font-size:1.2rem;">My Playlists</span></div>`;
        
        if(savedPlaylists.length === 0) {
            html += `<div style="text-align:center; margin-top:50px; color:var(--text-sub);">
                <i class="ri-play-list-add-line" style="font-size:3rem; opacity:0.3;"></i>
                <p>No playlists yet</p>
                <button class="neu-btn primary" style="width:auto; padding:0 20px; margin:20px auto;" onclick="switchTab('all'); toggleSelectionMode(true);">Create Playlist</button>
            </div>`;
        } else {
            savedPlaylists.forEach(pl => {
                html += `
                <div class="playlist-card" onclick="openPlaylist('${pl.id}')">
                    <div>
                        <h3 style="margin:0; font-size:1.1rem; color:var(--text-main);">${pl.name}</h3>
                        <p style="margin:5px 0 0; font-size:0.8rem; color:var(--text-sub); font-weight:600; text-transform:uppercase;">${pl.fileIds.length} TRACKS</p>
                    </div>
                    <div class="neu-btn" style="width:40px; height:40px; font-size:1rem;"><i class="ri-arrow-right-s-line"></i></div>
                </div>`;
            });
        }
        mainContainer.innerHTML = html;
    }

    function renderSinglePlaylist(id) {
        const playlist = savedPlaylists.find(p => p.id === id);
        if(!playlist) return switchTab('playlists');

        let html = `
            <div class="playlist-controls">
                <button class="neu-btn" onclick="switchTab('playlists')" style="width:40px; height:40px;"><i class="ri-arrow-left-line"></i></button>
                <button class="text-btn" onclick="deletePlaylist('${id}')" style="color:#ff7675;">Delete</button>
            </div>
            <h2 style="margin:0 0 30px; font-size:2rem; color:var(--text-main);">${playlist.name}</h2>
        `;

        const playlistTracks = playlist.fileIds.map(fileId => allFiles.find(f => f.public_id === fileId)).filter(Boolean);

        if (playlistTracks.length === 0) {
            html += `<p style="text-align:center; color:var(--text-sub);">No songs in this playlist.</p>`;
        } else {
            playlistTracks.forEach((file, i) => {
                let durationText = '--:--';
                if(file.duration) {
                    const m = Math.floor(file.duration / 60);
                    const s = String(Math.floor(file.duration % 60)).padStart(2, '0');
                    durationText = `${m}:${s}`;
                }

                const isCurrent = (currentQueue[currentTrackIndex]?.public_id === file.public_id && currentTab === 'single_playlist' && viewingPlaylistId === id);
                const activeClass = isCurrent ? 'active-track' : '';
                const icon = (isCurrent && isPlaying) ? '<i class="ri-pause-fill"></i>' : '<i class="ri-play-fill"></i>';

                html += `
                <div class="track ${activeClass}" onclick="handleTrackClick(${i}, 'playlist')">
                  <div class="track-play-btn">${icon}</div>
                  <div class="track-info">
                    <div class="track-artist">${file.cleanArtist}</div>
                    <div class="track-title">${file.cleanTitle}</div>
                  </div>
                  <div class="track-duration">${durationText}</div>
                </div>`;
            });
        }
        
        mainContainer.innerHTML = html;
    }

    // --- LOGIC ---

    function switchTab(tab) {
        currentTab = tab;
        isSelectionMode = false;
        selectedIndices.clear();
        
        document.getElementById('tab-all').classList.toggle('inactive', tab !== 'all');
        document.getElementById('tab-playlists').classList.toggle('inactive', tab !== 'playlists');

        if(tab === 'all') renderAllSongs();
        else if(tab === 'playlists') renderPlaylistsTab();
    }

    function handleTrackClick(index, context) {
        if (isSelectionMode && context === 'all') {
            if(selectedIndices.has(index)) selectedIndices.delete(index);
            else selectedIndices.add(index);
            renderAllSongs();
            return;
        }

        if (context === 'all') {
            currentQueue = [...allFiles];
            playTrack(index);
        } else if (context === 'playlist') {
            const playlist = savedPlaylists.find(p => p.id === viewingPlaylistId);
            if(playlist) {
                const playlistTracks = playlist.fileIds.map(id => allFiles.find(f => f.public_id === id)).filter(Boolean);
                currentQueue = playlistTracks;
                playTrack(index); 
            }
        }
    }

    function toggleSelectionMode(active) {
        isSelectionMode = active;
        selectedIndices.clear();
        renderAllSongs();
    }

    function openSaveModal() {
        if(selectedIndices.size === 0) return alert("Select songs first");
        document.getElementById('playlistModal').style.display = 'flex';
        document.getElementById('playlistNameInput').focus();
    }
    function closeModal() { document.getElementById('playlistModal').style.display = 'none'; }

    function confirmSavePlaylist() {
        const name = document.getElementById('playlistNameInput').value.trim() || "My Playlist";
        const selectedIds = Array.from(selectedIndices).map(idx => allFiles[idx].public_id);
        
        const newPlaylist = {
            id: Date.now().toString(),
            name: name,
            fileIds: selectedIds
        };
        savedPlaylists.push(newPlaylist);
        localStorage.setItem('vibePlaylists', JSON.stringify(savedPlaylists));
        closeModal();
        switchTab('playlists');
    }

    function openPlaylist(id) {
        viewingPlaylistId = id;
        currentTab = 'single_playlist';
        renderSinglePlaylist(id);
    }
    
    function deletePlaylist(id) {
        if(confirm("Delete playlist?")) {
            savedPlaylists = savedPlaylists.filter(p => p.id !== id);
            localStorage.setItem('vibePlaylists', JSON.stringify(savedPlaylists));
            switchTab('playlists');
        }
    }

    // --- PLAYER CONTROLS ---

    function playTrack(index) {
        if(index < 0 || index >= currentQueue.length) return;

        currentTrackIndex = index;
        const song = currentQueue[index];
        
        if(audioPlayer.src !== song.url) {
            audioPlayer.src = song.url;
        }
        
        currentTrackEl.textContent = song.cleanTitle;
        currentArtistEl.textContent = song.cleanArtist;

        audioPlayer.play().catch(e => console.log("User interaction needed"));
        isPlaying = true;
        updatePlayBtnUI();
        
        if(currentTab === 'all') renderAllSongs();
        if(currentTab === 'single_playlist') renderSinglePlaylist(viewingPlaylistId);
    }

    function updatePlayBtnUI() {
        playPauseBtn.innerHTML = isPlaying ? '<i class="ri-pause-fill"></i>' : '<i class="ri-play-fill"></i>';
    }

    function togglePlayPause() {
        if (!audioPlayer.src && currentQueue.length > 0) {
            playTrack(0);
            return;
        }
        if (isPlaying) audioPlayer.pause();
        else audioPlayer.play();
        
        isPlaying = !isPlaying;
        updatePlayBtnUI();
        
        if(currentTab === 'all') renderAllSongs();
        if(currentTab === 'single_playlist') renderSinglePlaylist(viewingPlaylistId);
    }

    function nextTrack() {
        if(isLoopEnabled) {
            audioPlayer.currentTime = 0;
            audioPlayer.play();
            return;
        }
        if (isShuffleEnabled) {
            currentTrackIndex = Math.floor(Math.random() * currentQueue.length);
        } else {
            currentTrackIndex = (currentTrackIndex + 1) % currentQueue.length;
        }
        playTrack(currentTrackIndex);
    }

    function prevTrack() {
        if (audioPlayer.currentTime > 3) {
            audioPlayer.currentTime = 0;
            return;
        }
        currentTrackIndex = (currentTrackIndex - 1 + currentQueue.length) % currentQueue.length;
        playTrack(currentTrackIndex);
    }
    
    function deleteCurrentTrack() {
        if(currentQueue.length === 0) return;
        const song = currentQueue[currentTrackIndex];
        const id = song.public_id.split('/').pop();
        if(confirm("Delete this file permanently?")) {
            window.location.href = `/AllBus/${id}`;
        }
    }

    loopBtn.onclick = () => {
        isLoopEnabled = !isLoopEnabled;
        loopBtn.classList.toggle('active', isLoopEnabled);
    };
    shuffleBtn.onclick = () => {
        isShuffleEnabled = !isShuffleEnabled;
        shuffleBtn.classList.toggle('active', isShuffleEnabled);
    };

    playPauseBtn.onclick = togglePlayPause;
    document.getElementById("nextBtn").onclick = nextTrack;
    document.getElementById("prevBtn").onclick = prevTrack;
    audioPlayer.onended = nextTrack;
    
    // --- TIMELINE LOGIC ---
    audioPlayer.ontimeupdate = () => {
        if(audioPlayer.duration) {
            const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            seekSlider.value = percent;
            updateSliderStyle(percent);
        }
    };

    seekSlider.oninput = () => {
        const seekTime = (seekSlider.value / 100) * audioPlayer.duration;
        audioPlayer.currentTime = seekTime;
        updateSliderStyle(seekSlider.value);
    };

    function updateSliderStyle(value) {
        const accent = getComputedStyle(document.body).getPropertyValue('--accent-deep').trim();
        const bg = `linear-gradient(to right, ${accent} 0%, ${accent} ${value}%, rgba(0,0,0,0.05) ${value}%, rgba(0,0,0,0.05) 100%)`;
        seekSlider.style.background = bg;
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        themeIcon.className = isDark ? 'ri-sun-line' : 'ri-moon-line';
        localStorage.setItem('vibeTheme', isDark ? 'dark' : 'light');
    }
    if(localStorage.getItem('vibeTheme') === 'dark') toggleTheme();

    renderAllSongs();
  </script>
</body>
</html>
